<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Мафія - Ведучий</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #121212;
            color: #f5f5f5;
        }
        /* Стилі для анімації картки */
        .card-container {
            perspective: 1200px; /* Глибокий 3D-ефект */
            width: 300px;
            height: 450px;
            margin: 20px auto;
            transform: translateZ(0); /* Апаратне прискорення */
        }
        .card {
            position: relative;
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
            transition: transform 0.6s ease-in-out; /* Плавне обертання */
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            will-change: transform;
        }
        .card.flipped {
            transform: rotateY(180deg);
        }
        .card-front,
        .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden; /* Приховує зворотну сторону */
            border-radius: 15px;
            background-size: cover;
            background-position: center;
            transition: opacity 0.6s ease-in-out; /* Синхронізована прозорість */
            will-change: opacity;
        }
        .card-back {
            background-image: url('img/CARD.png');
            opacity: 1;
            transform: translateZ(0);
        }
        .card-front {
            background-size: contain;
            background-repeat: no-repeat;
            background-color: #ffffff;
            opacity: 0;
            transform: rotateY(180deg) translateZ(0);
        }
        .card.flipped .card-front {
            opacity: 1;
        }
        .card.flipped .card-back {
            opacity: 0;
        }
        /* Стилі для гравців */
        .player-card {
            transition: all 0.3s ease;
        }
        .player-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }
        .selected-player {
            box-shadow: 0 0 0 3px rgba(74, 222, 128, 0.7);
        }
        .dead-player {
            opacity: 0.6;
            background-color: #4a5568 !important;
        }
        .player-profile {
            background-color: #374151;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
        }
        .player-profile:hover {
            transform: scale(1.05);
        }
        .player-profile img {
            width: 48px;
            height: 48px;
            border-radius: 9999px;
            object-fit: cover;
            margin: 0 auto 8px;
        }
        /* Модальні вікна */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #2d3748;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 10px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: #fff;
        }
        /* Скролбар */
        .scrollbar-custom::-webkit-scrollbar {
            width: 8px;
        }
        .scrollbar-custom::-webkit-scrollbar-track {
            background: #2d3748;
            border-radius: 4px;
        }
        .scrollbar-custom::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 4px;
        }
        .scrollbar-custom::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }
    </style>
    <!-- Попереднє завантаження зображень -->
    <link rel="preload" href="img/CARD.png" as="image">
    <link rel="preload" href="img/C MAFIA.png" as="image">
    <link rel="preload" href="img/C SHERIFF.png" as="image">
    <link rel="preload" href="img/C CIVILIAN.png" as="image">
    <link rel="preload" href="img/P MAFIA.png" as="image">
    <link rel="preload" href="img/P SHERIFF.png" as="image">
    <link rel="preload" href="img/P CIVILIAN.png" as="image">
</head>
<body class="min-h-screen flex flex-col">
    <!-- Модальні вікна -->
    <div id="votingModal" class="modal">
        <div class="modal-content">
            <span class="close">×</span>
            <h3 class="text-xl font-bold mb-4">Голосування</h3>
            <p class="mb-4">Оберіть гравця для вигнання:</p>
            <div id="votingPlayers" class="grid grid-cols-2 gap-3 mb-4"></div>
            <div class="text-center space-x-4">
                <button id="votingSkipBtn" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded">Пропустити</button>
                <button id="votingConfirmBtn" class="px-4 py-2 bg-green-600 hover:bg-green-500 rounded">Підтвердити</button>
            </div>
        </div>
    </div>

    <!-- Основний контейнер -->
    <div class="container mx-auto px-4 py-8 flex-grow">
        <header class="flex justify-center mb-8">
            <h1 class="text-3xl font-bold text-white">
                <i class="fas fa-user-secret mr-2"></i>Мафія - Ведучий
            </h1>
        </header>

        <div id="app">
            <!-- Екран налаштування -->
            <div id="setupScreen">
                <h2 class="text-2xl font-semibold mb-6 text-center">Налаштування гри</h2>
                <div class="bg-gray-800 rounded-lg p-6 mb-8 shadow-lg">
                    <h3 class="text-xl font-medium mb-4 flex justify-between">
                        <span><i class="fas fa-users mr-2"></i>Гравці</span>
                        <span id="playersCount" class="text-sm">0 гравців</span>
                    </h3>
                    <div class="flex mb-4">
                        <input type="text" id="playerNameInput" placeholder="Ім'я гравця"
                               class="flex-grow px-4 py-2 bg-gray-700 border border-gray-600 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <button id="addPlayerBtn" class="px-4 py-2 bg-purple-600 hover:bg-purple-500 text-white rounded-r-lg">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div id="playersList" class="grid grid-cols-2 sm:grid-cols-3 gap-3"></div>
                </div>
                <div class="bg-gray-800 rounded-lg p-6 shadow-lg">
                    <h3 class="text-xl font-medium mb-4">
                        <i class="fas fa-mask mr-2"></i>Ролі
                    </h3>
                    <div id="rolesSelection" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div class="flex items-center justify-between bg-gray-700 p-3 rounded-lg">
                            <div class="flex items-center">
                                <img src="img/P MAFIA.png" class="w-8 h-8 rounded-full mr-3">
                                <span>Мафія</span>
                            </div>
                            <div class="flex items-center">
                                <button data-role="mafia" data-action="decrease" class="w-8 h-8 bg-gray-600 hover:bg-gray-500 rounded-l-lg flex items-center justify-center">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <span id="mafiaCount" class="px-4">0</span>
                                <button data-role="mafia" data-action="increase" class="w-8 h-8 bg-gray-600 hover:bg-gray-500 rounded-r-lg flex items-center justify-center">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="flex items-center justify-between bg-gray-700 p-3 rounded-lg">
                            <div class="flex items-center">
                                <img src="img/P SHERIFF.png" class="w-8 h-8 rounded-full mr-3">
                                <span>Шериф</span>
                            </div>
                            <div class="flex items-center">
                                <button data-role="sheriff" data-action="decrease" class="w-8 h-8 bg-gray-600 hover:bg-gray-500 rounded-l-lg flex items-center justify-center">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <span id="sheriffCount" class="px-4">0</span>
                                <button data-role="sheriff" data-action="increase" class="w-8 h-8 bg-gray-600 hover:bg-gray-500 rounded-r-lg flex items-center justify-center">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="flex items-center justify-between bg-gray-700 p-3 rounded-lg">
                            <div class="flex items-center">
                                <img src="img/P CIVILIAN.png" class="w-8 h-8 rounded-full mr-3">
                                <span>Мирний</span>
                            </div>
                            <div class="flex items-center">
                                <button data-role="civilian" data-action="decrease" class="w-8 h-8 bg-gray-600 hover:bg-gray-500 rounded-l-lg flex items-center justify-center">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <span id="civilianCount" class="px-4">0</span>
                                <button data-role="civilian" data-action="increase" class="w-8 h-8 bg-gray-600 hover:bg-gray-500 rounded-r-lg flex items-center justify-center">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 text-center">
                        <button id="startGameBtn" class="px-6 py-3 bg-green-600 hover:bg-green-500 text-white font-bold rounded-lg disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="fas fa-play mr-2"></i>Почати гру
                        </button>
                    </div>
                </div>
            </div>

            <!-- Екран знайомства -->
            <div id="introductionScreen" class="hidden">
                <h2 class="text-2xl font-semibold mb-6 text-center">Знайомство з ролями</h2>
                <div class="bg-gray-800 rounded-lg p-6 mb-8 shadow-lg">
                    <div class="text-center mb-6">
                        <div class="text-lg font-medium">Гравець: <span id="currentPlayerName"></span></div>
                        <div class="card-container">
                            <div class="card">
                                <div class="card-front"></div>
                                <div class="card-back"></div>
                            </div>
                        </div>
                    </div>
                    <div class="text-center">
                        <button id="continueIntroBtn" class="px-6 py-3 bg-purple-600 hover:bg-purple-500 text-white font-bold rounded-lg">
                            Перевернути карту
                        </button>
                    </div>
                </div>
            </div>

            <!-- Екран гри -->
            <div id="gameScreen" class="hidden">
                <h2 id="gamePhaseTitle" class="text-2xl font-semibold mb-6 text-center">
                    <i class="fas fa-sun mr-2"></i>День 1
                </h2>
                <div class="mb-6 flex justify-center">
                    <button id="nextPhaseBtn" class="px-6 py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg">
                        <span id="btnPhaseText">Місто засинає</span>
                        <i class="fas fa-moon ml-2" id="btnPhaseIcon"></i>
                    </button>
                </div>
                <div class="bg-gray-800 rounded-lg p-6 mb-6 shadow-lg">
                    <h3 class="text-xl font-medium mb-4 flex justify-between">
                        <span id="actionTitle"><i class="fas fa-heartbeat mr-2"></i>Живі гравці</span>
                        <span id="aliveCount" class="text-sm"></span>
                    </h3>
                    <p id="actionDescription" class="mb-4"></p>
                    <div id="alivePlayers" class="grid grid-cols-2 sm:grid-cols-3 gap-4"></div>
                </div>
                <div class="bg-gray-800 rounded-lg p-6 mb-6 shadow-lg">
                    <h3 class="text-xl font-medium mb-4">
                        <i class="fas fa-scroll mr-2"></i>Лог подій
                    </h3>
                    <div id="gameLog" class="bg-gray-900 p-4 rounded-lg h-64 overflow-y-auto scrollbar-custom"></div>
                </div>
                <div class="bg-gray-800 rounded-lg p-6 mb-6 shadow-lg">
                    <h3 class="text-xl font-medium mb-4">
                        <i class="fas fa-skull mr-2"></i>Мертві гравці
                        <span id="deadCount" class="text-sm ml-2"></span>
                    </h3>
                    <div id="deadPlayers" class="grid grid-cols-2 sm:grid-cols-3 gap-4"></div>
                </div>
                <div class="text-center">
                    <button id="endGameBtn" class="px-6 py-3 bg-red-600 hover:bg-red-500 text-white font-bold rounded-lg">
                        <i class="fas fa-power-off mr-2"></i>Завершити гру
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Дані ролей
        const rolesData = [
            { id: 'mafia', name: 'Мафія', profileImage: 'img/P MAFIA.png', cardImage: 'img/C MAFIA.png', team: 'mafia' },
            { id: 'sheriff', name: 'Шериф', profileImage: 'img/P SHERIFF.png', cardImage: 'img/C SHERIFF.png', team: 'civilian' },
            { id: 'civilian', name: 'Мирний', profileImage: 'img/P CIVILIAN.png', cardImage: 'img/C CIVILIAN.png', team: 'civilian' }
        ];

        // Стан гри
        const gameState = {
            phase: 'setup',
            players: [],
            roles: { mafia: 0, sheriff: 0, civilian: 0 },
            day: 1,
            isDay: true,
            voting: [],
            currentPlayerIndex: 0,
            selectedPlayer: null,
            gameLog: []
        };

        // Елементи DOM
        const elements = {
            setupScreen: document.getElementById('setupScreen'),
            introductionScreen: document.getElementById('introductionScreen'),
            gameScreen: document.getElementById('gameScreen'),
            playerNameInput: document.getElementById('playerNameInput'),
            addPlayerBtn: document.getElementById('addPlayerBtn'),
            playersList: document.getElementById('playersList'),
            playersCount: document.getElementById('playersCount'),
            rolesSelection: document.getElementById('rolesSelection'),
            startGameBtn: document.getElementById('startGameBtn'),
            currentPlayerName: document.getElementById('currentPlayerName'),
            continueIntroBtn: document.getElementById('continueIntroBtn'),
            gamePhaseTitle: document.getElementById('gamePhaseTitle'),
            actionTitle: document.getElementById('actionTitle'),
            actionDescription: document.getElementById('actionDescription'),
            alivePlayers: document.getElementById('alivePlayers'),
            aliveCount: document.getElementById('aliveCount'),
            deadPlayers: document.getElementById('deadPlayers'),
            deadCount: document.getElementById('deadCount'),
            gameLog: document.getElementById('gameLog'),
            nextPhaseBtn: document.getElementById('nextPhaseBtn'),
            btnPhaseText: document.getElementById('btnPhaseText'),
            btnPhaseIcon: document.getElementById('btnPhaseIcon'),
            endGameBtn: document.getElementById('endGameBtn'),
            votingModal: document.getElementById('votingModal'),
            votingPlayers: document.getElementById('votingPlayers'),
            votingConfirmBtn: document.getElementById('votingConfirmBtn'),
            votingSkipBtn: document.getElementById('votingSkipBtn')
        };

        // Ініціалізація слухачів подій
        function setupEventListeners() {
            elements.addPlayerBtn.addEventListener('click', addPlayer);
            elements.rolesSelection.addEventListener('click', updateRoleCount);
            elements.startGameBtn.addEventListener('click', startGame);
            elements.continueIntroBtn.addEventListener('click', continueIntroduction);
            elements.nextPhaseBtn.addEventListener('click', nextPhase);
            elements.endGameBtn.addEventListener('click', endGame);
            elements.votingConfirmBtn.addEventListener('click', confirmVoting);
            elements.votingSkipBtn.addEventListener('click', skipVoting);
            elements.votingModal.querySelector('.close').addEventListener('click', closeVotingModal);
        }

        // Додавання гравця
        function addPlayer() {
            const name = elements.playerNameInput.value.trim();
            if (name && !gameState.players.some(p => p.name === name)) {
                gameState.players.push({ name, status: 'alive', role: null });
                elements.playerNameInput.value = '';
                renderPlayers();
                updateStartGameButton();
            } else {
                alert('Введіть унікальне ім\'я гравця!');
            }
        }

        // Оновлення кількості ролей
        function updateRoleCount(event) {
            const button = event.target.closest('[data-role]');
            if (!button) return;
            const role = button.dataset.role;
            const action = button.dataset.action;
            let count = gameState.roles[role];
            if (action === 'increase' && count < gameState.players.length) count++;
            if (action === 'decrease' && count > 0) count--;
            gameState.roles[role] = count;
            document.getElementById(`${role}Count`).textContent = count;
            updateStartGameButton();
        }

        // Оновлення кнопки старту
        function updateStartGameButton() {
            const totalRoles = Object.values(gameState.roles).reduce((sum, count) => sum + count, 0);
            elements.startGameBtn.disabled = totalRoles !== gameState.players.length;
        }

        // Відображення гравців
        function renderPlayers() {
            elements.playersList.innerHTML = gameState.players.map((player, index) => `
                <div class="player-card bg-gray-700 p-3 rounded-lg flex justify-between items-center">
                    <span>${player.name}</span>
                    <button class="text-red-500 hover:text-red-400" onclick="gameState.players.splice(${index}, 1); renderPlayers(); updateStartGameButton();">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `).join('');
            elements.playersCount.textContent = `${gameState.players.length} гравців`;
        }

        // Початок гри
        function startGame() {
            const totalRoles = Object.values(gameState.roles).reduce((sum, count) => sum + count, 0);
            if (totalRoles !== gameState.players.length) {
                alert('Кількість ролей має відповідати кількості гравців!');
                return;
            }
            assignRoles();
            gameState.phase = 'introduction';
            gameState.currentPlayerIndex = 0;
            switchScreen('introduction');
            renderIntroduction();
        }

        // Розподіл ролей
        function assignRoles() {
            const rolesArray = [];
            Object.entries(gameState.roles).forEach(([role, count]) => {
                for (let i = 0; i < count; i++) {
                    rolesArray.push(rolesData.find(r => r.id === role));
                }
            });
            // Випадкове перемішування (алгоритм Фішера-Йетса)
            for (let i = rolesArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [rolesArray[i], rolesArray[j]] = [rolesArray[j], rolesArray[i]];
            }
            gameState.players.forEach((player, index) => {
                player.role = rolesArray[index];
            });
        }

        // Перемикання екранів
        function switchScreen(screen) {
            elements.setupScreen.classList.add('hidden');
            elements.introductionScreen.classList.add('hidden');
            elements.gameScreen.classList.add('hidden');
            if (screen === 'setup') elements.setupScreen.classList.remove('hidden');
            if (screen === 'introduction') elements.introductionScreen.classList.remove('hidden');
            if (screen === 'game') elements.gameScreen.classList.remove('hidden');
        }

        // Відображення екрану знайомства
        function renderIntroduction() {
            if (gameState.currentPlayerIndex >= gameState.players.length) {
                gameState.phase = 'game';
                gameState.isDay = true;
                gameState.day = 1;
                switchScreen('game');
                startDayPhase();
                return;
            }
            const player = gameState.players[gameState.currentPlayerIndex];
            elements.currentPlayerName.textContent = player.name;
            elements.continueIntroBtn.textContent = 'Перевернути карту';
            elements.continueIntroBtn.disabled = false;
            const card = document.querySelector('.card');
            const cardFront = document.querySelector('.card-front');
            cardFront.style.backgroundImage = '';
            card.classList.remove('flipped');
        }

        // Продовження знайомства (анімація картки)
        function continueIntroduction() {
            const card = document.querySelector('.card');
            const cardFront = document.querySelector('.card-front');
            const player = gameState.players[gameState.currentPlayerIndex];

            if (!card.classList.contains('flipped')) {
                cardFront.style.backgroundImage = `url('${player.role.cardImage}')`;
                card.classList.add('flipped');
                elements.continueIntroBtn.textContent = 'Продовжити';
            } else {
                card.classList.remove('flipped');
                elements.continueIntroBtn.disabled = true;
                const onTransitionEnd = () => {
                    card.removeEventListener('transitionend', onTransitionEnd);
                    cardFront.style.backgroundImage = '';
                    gameState.currentPlayerIndex++;
                    renderIntroduction();
                };
                card.addEventListener('transitionend', onTransitionEnd);
            }
        }

        // Початок денної фази
        function startDayPhase() {
            gameState.isDay = true;
            elements.gamePhaseTitle.innerHTML = `<i class="fas fa-sun mr-2"></i>День ${gameState.day}`;
            elements.btnPhaseText.textContent = 'Місто засинає';
            elements.btnPhaseIcon.className = 'fas fa-moon ml-2';
            gameState.voting = [];
            gameState.selectedPlayer = null;
            elements.actionTitle.innerHTML = `<i class="fas fa-sun mr-2"></i>Денне обговорення`;
            elements.actionDescription.textContent = 'Гравці обговорюють і висувають кандидатів на голосування. Клікайте на гравців, щоб обрати кандидатів.';
            renderPlayersStatus();
            renderGameLog();
            checkGameEnd();
        }

        // Відображення статусу гравців
        function renderPlayersStatus() {
            const alivePlayers = gameState.players.filter(p => p.status === 'alive');
            elements.alivePlayers.innerHTML = alivePlayers.map(player => `
                <div class="player-profile ${gameState.voting.includes(player.name) || gameState.selectedPlayer === player.name ? 'selected-player' : ''}" 
                    data-name="${player.name}">
                    <img src="${player.role.profileImage}" alt="${player.role.name}">
                    <div class="text-center font-medium">${player.name}</div>
                    <div class="text-center text-sm text-gray-400">${player.role.name}</div>
                </div>
            `).join('');
            elements.deadPlayers.innerHTML = gameState.players.filter(p => p.status === 'dead').map(player => `
                <div class="player-profile dead-player">
                    <img src="${player.role.profileImage}" alt="${player.role.name}">
                    <div class="text-center font-medium">${player.name}</div>
                    <div class="text-center text-sm text-gray-400">${player.role.name}</div>
                    <div class="text-center text-xs text-gray-400">${player.deathReason}, ${player.deathTime}</div>
                </div>
            `).join('');
            elements.aliveCount.textContent = `${alivePlayers.length} гравців`;
            elements.deadCount.textContent = `${gameState.players.filter(p => p.status === 'dead').length} гравців`;

            elements.alivePlayers.querySelectorAll('.player-profile').forEach(profile => {
                profile.addEventListener('click', () => {
                    const name = profile.dataset.name;
                    if (gameState.isDay) {
                        if (gameState.voting.includes(name)) {
                            gameState.voting = gameState.voting.filter(n => n !== name);
                        } else {
                            gameState.voting.push(name);
                        }
                        if (gameState.voting.length >= 2) {
                            openVotingModal();
                        }
                    } else {
                        gameState.selectedPlayer = gameState.selectedPlayer === name ? null : name;
                    }
                    renderPlayersStatus();
                });
            });
        }

        // Відкриття модального вікна голосування
        function openVotingModal() {
            const candidates = gameState.voting;
            let selectedPlayer = null;
            elements.votingPlayers.innerHTML = candidates.map(name => `
                <div class="player-card bg-gray-700 p-3 rounded-lg cursor-pointer" data-name="${name}">
                    <img src="${gameState.players.find(p => p.name === name).role.profileImage}" class="w-12 h-12 rounded-full mx-auto mb-2">
                    <div class="text-center font-medium">${name}</div>
                    <div class="text-center text-xs text-gray-400">${gameState.players.find(p => p.name === name).role.name}</div>
                </div>
            `).join('');
            elements.votingModal.style.display = 'block';

            elements.votingPlayers.querySelectorAll('.player-card').forEach(card => {
                card.addEventListener('click', () => {
                    elements.votingPlayers.querySelectorAll('.player-card').forEach(c => c.classList.remove('selected-player'));
                    card.classList.add('selected-player');
                    selectedPlayer = card.dataset.name;
                });
            });

            elements.votingConfirmBtn.onclick = () => confirmVoting(selectedPlayer);
            elements.votingSkipBtn.onclick = skipVoting;
        }

        // Підтвердження голосування
        function confirmVoting(selectedPlayer) {
            if (!selectedPlayer) {
                alert('Оберіть гравця!');
                return;
            }
            const player = gameState.players.find(p => p.name === selectedPlayer);
            player.status = 'dead';
            player.deathReason = 'Вигнаний';
            player.deathTime = `День ${gameState.day}`;
            logGameEvent(`День ${gameState.day}: ${player.name} вигнаний за голосуванням.`);
            elements.votingModal.style.display = 'none';
            gameState.voting = [];
            renderPlayersStatus();
            checkGameEnd();
        }

        // Пропуск голосування
        function skipVoting() {
            logGameEvent(`День ${gameState.day}: Голосування пропущено, нікого не вигнано.`);
            elements.votingModal.style.display = 'none';
            gameState.voting = [];
            renderPlayersStatus();
        }

        // Закриття модального вікна
        function closeVotingModal() {
            elements.votingModal.style.display = 'none';
            gameState.voting = [];
            renderPlayersStatus();
        }

        // Перехід до наступної фази
        function nextPhase() {
            if (gameState.isDay) {
                gameState.isDay = false;
                logGameEvent(`Почалася ніч ${gameState.day}.`);
                gameState.selectedPlayer = null;
                startNightPhase();
            } else {
                const target = gameState.selectedPlayer;
                if (target && gameState.players.some(p => p.role.id === 'mafia' && p.status === 'alive')) {
                    const player = gameState.players.find(p => p.name === target);
                    player.status = 'dead';
                    player.deathReason = 'Вбитий (Мафія)';
                    player.deathTime = `Ніч ${gameState.day}`;
                    logGameEvent(`Ніч ${gameState.day}: ${player.name} був убитий Мафією.`);
                }
                gameState.isDay = true;
                gameState.day++;
                logGameEvent(`Почався день ${gameState.day}.`);
                startDayPhase();
            }
        }

        // Початок нічної фази
        function startNightPhase() {
            elements.gamePhaseTitle.innerHTML = `<i class="fas fa-moon mr-2"></i>Ніч ${gameState.day}`;
            elements.btnPhaseText.textContent = 'Місто прокидається';
            elements.btnPhaseIcon.className = 'fas fa-sun ml-2';
            elements.actionTitle.innerHTML = `<i class="fas fa-moon mr-2"></i>Прокидається Мафія`;
            elements.actionDescription.textContent = 'Оберіть гравця для вбивства або натисніть "Місто прокидається" для пропуску.';
            renderPlayersStatus();
        }

        // Перевірка умов завершення гри
        function checkGameEnd() {
            const alivePlayers = gameState.players.filter(p => p.status === 'alive');
            const mafiaCount = alivePlayers.filter(p => p.role.team === 'mafia').length;
            const civilianCount = alivePlayers.filter(p => p.role.team === 'civilian').length;

            if (mafiaCount === 0) {
                logGameEvent('Мирні жителі перемогли!');
                alert('Мирні жителі перемогли!');
                endGame();
            } else if (mafiaCount >= civilianCount) {
                logGameEvent('Мафія перемогла!');
                alert('Мафія перемогла!');
                endGame();
            }
        }

        // Завершення гри
        function endGame() {
            gameState.phase = 'setup';
            gameState.players = gameState.players.map(p => ({ name: p.name, status: 'alive', role: null }));
            gameState.roles = { mafia: 0, sheriff: 0, civilian: 0 };
            gameState.day = 1;
            gameState.isDay = true;
            gameState.voting = [];
            gameState.currentPlayerIndex = 0;
            gameState.selectedPlayer = null;
            gameState.gameLog = [];
            switchScreen('setup');
            renderPlayers();
            updateStartGameButton();
        }

        // Логування подій
        function logGameEvent(event) {
            gameState.gameLog.push(event);
            renderGameLog();
        }

        // Відображення логу
        function renderGameLog() {
            elements.gameLog.innerHTML = gameState.gameLog.slice().reverse().map(event => `<p>${event}</p>`).join('');
            elements.gameLog.scrollTop = elements.gameLog.scrollHeight;
        }

        // Ініціалізація
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            renderPlayers();
            updateStartGameButton();
        });
    </script>
</body>
    </html>
