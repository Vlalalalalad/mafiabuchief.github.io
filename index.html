<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="gameTitle"></title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #121212;
            color: #f5f5f5;
            transition: all 0.3s ease;
        }
        .player-card {
            transition: all 0.3s ease;
        }
        .player-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }
        .role-quantity {
            min-width: 30px;
            text-align: center;
        }
        .selected-player {
            animation: pulse 2s infinite;
            box-shadow: 0 0 0 3px rgba(74, 222, 128, 0.7);
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(74, 222, 128, 0); }
            100% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0); }
        }
        .dead-player, .exiled-player {
            opacity: 0.6;
            background-color: #4a5568 !important;
        }
        .card-container {
            perspective: 1200px;
            width: 300px;
            height: 450px;
            margin: 20px auto;
            cursor: pointer;
            user-select: none;
            transform: translateZ(0);
        }
        .card {
            position: relative;
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
            transition: transform 0.6s ease-in-out;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            will-change: transform;
        }
        .card.flipped {
            transform: rotateY(180deg);
        }
        .card-front,
        .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 15px;
            background-size: cover;
            background-position: center;
            transition: opacity 0.6s ease-in-out;
            will-change: opacity;
        }
        .card-back {
            background-image: url('img/CARD.png');
            opacity: 1;
            transform: translateZ(0);
        }
        .card-front {
            background-size: contain;
            background-repeat: no-repeat;
            background-color: #ffffff;
            opacity: 0;
            transform: rotateY(180deg) translateZ(0);
        }
        .card.flipped .card-front {
            opacity: 1;
        }
        .card.flipped .card-back {
            opacity: 0;
        }
        .player-profile {
            text-align: center;
            background-color: #374151;
            padding: 12px;
            border-radius: 8px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .player-profile:hover {
            transform: scale(1.05);
        }
        .player-profile img {
            width: 48px;
            height: 48px;
            border-radius: 9999px;
            object-fit: cover;
            margin-left: auto;
            margin-right: auto;
            margin-bottom: 8px;
        }
        .player-profile .name {
            font-size: 1.125rem;
            font-weight: 500;
            margin-bottom: 4px;
        }
        .player-profile .role {
            font-size: 0.875rem;
            color: #9ca3af;
            text-transform: lowercase;
            margin-bottom: 4px;
        }
        .player-profile .status {
            font-size: 0.75rem;
            color: #9ca3af;
        }
        .scrollbar-custom::-webkit-scrollbar {
            width: 8px;
        }
        .scrollbar-custom::-webkit-scrollbar-track {
            background: #2d3748;
            border-radius: 4px;
        }
        .scrollbar-custom::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 4px;
        }
        .scrollbar-custom::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #2d3748;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 10px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover,
        .close:focus {
            color: #fff;
            text-decoration: none;
        }
    </style>
    <link rel="preload" href="img/CARD.png" as="image">
    <link rel="preload" href="img/C LOVER.png" as="image">
    <link rel="preload" href="img/C MAFIA.png" as="image">
    <link rel="preload" href="img/C DON.png" as="image">
    <link rel="preload" href="img/C SHERIFF.png" as="image">
    <link rel="preload" href="img/C DOCTOR.png" as="image">
    <link rel="preload" href="img/C MANIAC.png" as="image">
    <link rel="preload" href="img/C WITNESS.png" as="image">
    <link rel="preload" href="img/C CIVILIAN.png" as="image">
    <link rel="preload" href="img/P LOVER.png" as="image">
    <link rel="preload" href="img/P MAFIA.png" as="image">
    <link rel="preload" href="img/P DON.png" as="image">
    <link rel="preload" href="img/P SHERIFF.png" as="image">
    <link rel="preload" href="img/P DOCTOR.png" as="image">
    <link rel="preload" href="img/P MANIAC.png" as="image">
    <link rel="preload" href="img/P WITNESS.png" as="image">
    <link rel="preload" href="img/P CIVILIAN.png" as="image">
</head>
<body class="min-h-screen flex flex-col">
    <!-- Модальні вікна -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <span class="close">×</span>
            <h3 class="text-xl font-bold mb-4 text-center" data-i18n="confirmTitle"></h3>
            <p class="mb-6 text-center" data-i18n="confirmDescription"></p>
            <div class="flex justify-center space-x-4">
                <button id="confirmCancel" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded transition" data-i18n="no"></button>
                <button id="confirmEnd" class="px-4 py-2 bg-red-600 hover:bg-red-500 rounded transition" data-i18n="yes"></button>
            </div>
        </div>
    </div>
    <div id="votingModal" class="modal">
        <div class="modal-content">
            <span class="close">×</span>
            <h3 class="text-xl font-bold mb-4" data-i18n="votingTitle"></h3>
            <p class="mb-4" data-i18n="votingDescription"></p>
            <div id="votingPlayers" class="grid grid-cols-2 sm:grid-cols-3 gap-3 mb-4"></div>
            <div class="text-center space-x-4">
                <button id="votingSkipBtn" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded" data-i18n="skip"></button>
                <button id="votingConfirmBtn" class="px-4 py-2 bg-green-600 hover:bg-green-500 rounded" data-i18n="confirm"></button>
            </div>
        </div>
    </div>
    <div id="nightResultsModal" class="modal">
        <div class="modal-content">
            <span class="close">×</span>
            <h3 class="text-xl font-bold mb-4" data-i18n="nightResultsTitle"></h3>
            <div id="nightResults" class="mb-4"></div>
            <div class="text-center">
                <button id="nightResultsConfirmBtn" class="px-4 py-2 bg-green-600 hover:bg-green-500 rounded" data-i18n="continue"></button>
            </div>
        </div>
    </div>
    <div id="witnessSecondActionModal" class="modal">
        <div class="modal-content">
            <span class="close">×</span>
            <h3 class="text-xl font-bold mb-4" data-i18n="witnessSecondTitle"></h3>
            <p id="witnessSecondResult" class="mb-4"></p>
            <div class="text-center">
                <button id="witnessSecondActionConfirmBtn" class="px-4 py-2 bg-green-600 hover:bg-green-500 rounded" data-i18n="witnessSleeps"></button>
            </div>
        </div>
    </div>

    <!-- Основний контейнер -->
    <div class="container mx-auto px-4 py-8 flex-grow">
        <header class="flex justify-center items-center mb-8">
            <h1 class="text-3xl font-bold text-center text-white">
                <i class="fas fa-user-secret mr-2"></i><span data-i18n="gameTitle"></span>
            </h1>
        </header>

        <div id="app" class="transition-all duration-300">
            <!-- Екран налаштування -->
            <div id="setupScreen">
                <h2 class="text-2xl font-semibold mb-6 text-center" data-i18n="setupTitle"></h2>
                <div class="bg-gray-800 rounded-lg p-6 mb-8 shadow-lg">
                    <h3 class="text-xl font-medium mb-4 flex items-center justify-between">
                        <span><i class="fas fa-users mr-2"></i><span data-i18n="players"></span></span>
                        <div class="flex items-center space-x-4">
                            <span class="text-sm font-normal" id="playersCount"></span>
                            <button id="changeLanguageBtn" class="px-3 py-1 bg-blue-600 hover:bg-blue-500 text-white rounded-lg">
                                <span id="languageLabel">UK</span>
                            </button>
                        </div>
                    </h3>
                    <div class="flex mb-4">
                        <input type="text" id="playerNameInput" data-i18n-placeholder="playerNamePlaceholder"
                               class="flex-grow px-4 py-2 bg-gray-700 border border-gray-600 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <button id="addPlayerBtn" class="px-4 py-2 bg-purple-600 hover:bg-purple-500 text-white rounded-r-lg transition-transform transform hover:scale-105">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div id="playersList" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3"></div>
                </div>
                <div class="bg-gray-800 rounded-lg p-6 shadow-lg">
                    <h3 class="text-xl font-medium mb-4 flex items-center">
                        <i class="fas fa-mask mr-2"></i><span data-i18n="roles"></span>
                    </h3>
                    <div id="rolesSelection" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
                    <div class="mt-6 text-center">
                        <button id="startGameBtn" class="px-6 py-3 bg-green-600 hover:bg-green-500 text-white font-bold rounded-lg transition-all transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none">
                            <i class="fas fa-play mr-2"></i><span data-i18n="startGame"></span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Екран знайомства -->
            <div id="introductionScreen" class="hidden">
                <h2 class="text-2xl font-semibold mb-6 text-center" data-i18n="introductionTitle"></h2>
                <div class="bg-gray-800 rounded-lg p-6 mb-8 shadow-lg">
                    <div id="introSteps" class="mb-6 text-center">
                        <div class="player-label text-lg font-medium" data-i18n="player"></div>
                        <div class="card-container">
                            <div class="card">
                                <div class="card-front"></div>
                                <div class="card-back"></div>
                            </div>
                        </div>
                    </div>
                    <div class="text-center">
                        <button id="continueIntroBtn" class="px-6 py-3 bg-purple-600 hover:bg-purple-500 text-white font-bold rounded-lg transition-all transform hover:scale-105" data-i18n="flipCard"></button>
                    </div>
                </div>
            </div>

            <!-- Екран гри -->
            <div id="gameScreen" class="hidden">
                <h2 id="gamePhaseTitle" class="text-2xl font-semibold mb-6 text-center"></h2>
                <div class="mb-6 flex justify-center">
                    <button id="nextPhaseBtn" class="px-6 py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg transition-all transform hover:scale-105">
                        <span id="btnPhaseText"></span>
                        <i id="btnPhaseIcon" class="ml-2"></i>
                    </button>
                </div>
                <div class="bg-gray-800 rounded-lg p-6 mb-6 shadow-lg">
                    <h3 class="text-xl font-medium mb-4 flex items-center justify-between">
                        <span id="actionTitle"></span>
                        <span id="aliveCount" class="text-sm font-normal"></span>
                        <span id="actionProgress" class="text-sm bg-gray-700 px-2 py-1 rounded"></span>
                    </h3>
                    <p id="actionDescription" class="mb-4"></p>
                    <div id="alivePlayers" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>
                </div>
                <div class="bg-gray-800 rounded-lg p-6 mb-6 shadow-lg">
                    <h3 class="text-xl font-medium mb-4 flex items-center">
                        <i class="fas fa-scroll mr-2"></i><span data-i18n="gameLog"></span>
                    </h3>
                    <div id="gameLog" class="bg-gray-900 p-4 rounded-lg h-64 overflow-y-auto scrollbar-custom"></div>
                </div>
                <div class="bg-gray-800 rounded-lg p-6 mb-6 shadow-lg">
                    <h3 class="text-xl font-medium mb-4 flex items-center">
                        <i class="fas fa-skull mr-2"></i><span data-i18n="deadPlayers"></span>
                        <span id="deadCount" class="text-sm font-normal ml-2"></span>
                    </h3>
                    <div id="deadPlayers" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>
                </div>
                <div class="mt-6 text-center">
                    <button id="endGameBtn" class="px-6 py-3 bg-red-600 hover:bg-red-500 text-white font-bold rounded-lg transition-transform transform hover:scale-105">
                        <i class="fas fa-power-off mr-2"></i><span data-i18n="endGame"></span>
                    </button>
                </div>
            </div>
        </div>
        <footer class="py-4 bg-gray-900 text-center text-gray-400">
            <p data-i18n="footer"></p>
        </footer>
    </div>

    <script>
        const rolesData = [
            { id: 'lover', profileImage: 'img/P LOVER.png', cardImage: 'img/C LOVER.png', team: 'civilian' },
            { id: 'mafia', profileImage: 'img/P MAFIA.png', cardImage: 'img/C MAFIA.png', team: 'mafia' },
            { id: 'don', profileImage: 'img/P DON.png', cardImage: 'img/C DON.png', team: 'mafia' },
            { id: 'sheriff', profileImage: 'img/P SHERIFF.png', cardImage: 'img/C SHERIFF.png', team: 'civilian' },
            { id: 'doctor', profileImage: 'img/P DOCTOR.png', cardImage: 'img/C DOCTOR.png', team: 'civilian' },
            { id: 'maniac', profileImage: 'img/P MANIAC.png', cardImage: 'img/C MANIAC.png', team: 'solo' },
            { id: 'witness', profileImage: 'img/P WITNESS.png', cardImage: 'img/C WITNESS.png', team: 'civilian' },
            { id: 'civilian', profileImage: 'img/P CIVILIAN.png', cardImage: 'img/C CIVILIAN.png', team: 'civilian' }
        ];

        const gameState = {
            currentPhase: 'setup',
            players: [],
            savedPlayers: [],
            roles: { lover: 0, mafia: 0, don: 0, sheriff: 0, doctor: 0, maniac: 0, witness: 0, civilian: 0 },
            savedRoles: { lover: 0, mafia: 0, don: 0, sheriff: 0, doctor: 0, maniac: 0, witness: 0, civilian: 0 },
            currentDay: 1,
            currentNight: 0,
            isDay: true,
            actions: {},
            voting: [],
            currentPlayerIndex: 0,
            currentRoleIndex: 0,
            gameLog: [],
            currentLanguage: 'uk',
            selectedPlayer: null,
            nightResults: []
        };

        const translations = {
            uk: {
                gameTitle: 'Мафія - Ведучий',
                setupTitle: 'Налаштування гри',
                players: 'Гравці',
                roles: 'Розподіл ролей',
                startGame: 'Почати гру',
                introductionTitle: 'Знайомство з ролями',
                player: 'Гравець: <span id="currentPlayerName"></span>',
                flipCard: 'Перевернути карту',
                continue: 'Продовжити',
                day: 'День',
                night: 'Ніч',
                citySleeps: 'Місто засинає',
                cityWakes: 'Місто прокидається',
                dayDiscussion: 'Денне обговорення',
                alivePlayers: 'Живі гравці',
                gameLog: 'Лог подій',
                deadPlayers: 'Мертві та вигнані',
                endGame: 'Завершити гру',
                confirmTitle: 'Підтвердження',
                confirmDescription: 'Ви впевнені, що хочете завершити гру?',
                no: 'Ні',
                yes: 'Так',
                votingTitle: 'Голосування',
                votingDescription: 'Оберіть гравця для вигнання (або пропустіть):',
                skip: 'Пропустити',
                confirm: 'Підтвердити',
                nightResultsTitle: 'Результати ночі',
                witnessSecondTitle: 'Повторна дія Свідка',
                witnessSleeps: 'Свідок засинає',
                selectVote: 'Оберіть гравця для дії!',
                playerNamePlaceholder: 'Ім\'я гравця',
                playerOne: 'гравець',
                playerFew: 'гравці',
                playerMany: 'гравців',
                lover: 'Коханка',
                mafia: 'Мафія',
                don: 'Дон',
                sheriff: 'Шериф',
                doctor: 'Лікар',
                maniac: 'Маніяк',
                witness: 'Свідок',
                civilian: 'Мирний',
                loverAction: 'Прокидається Коханка',
                witnessAction: 'Прокидається Свідок',
                mafiaAction: 'Прокидається Мафія',
                donAction: 'Прокидається Дон',
                sheriffAction: 'Прокидається Шериф',
                doctorAction: 'Прокидається Лікар',
                maniacAction: 'Прокидається Маніяк',
                witnessSecondAction: 'Прокидається Свідок (повторно)',
                loverSleeps: 'Коханка засинає',
                mafiaSleeps: 'Мафія засинає',
                donSleeps: 'Дон засинає',
                sheriffSleeps: 'Шериф засинає',
                doctorSleeps: 'Лікар засинає',
                maniacSleeps: 'Маніяк засинає',
                blockedByLover: 'Заблоковано Коханкою',
                killedByMafia: 'Вбитий (Мафія)',
                killedByManiac: 'Вбитий (Маніяк)',
                killedWithLover: 'Вбита (Коханка)',
                exiled: 'Вигнаний',
                loverAlibi: 'має алібі від Коханки і залишається в грі',
                votingSkipped: 'Голосування пропущено, нікого не вигнано',
                civiliansWin: 'Мирні жителі перемогли!',
                mafiaWins: 'Мафія перемогла!',
                maniacWins: 'Маніяк переміг!',
                footer: 'Гра "Мафія" © 2025 | Система для ведучого'
            },
            ru: {
                gameTitle: 'Мафия - Ведущий',
                setupTitle: 'Настройка игры',
                players: 'Игроки',
                roles: 'Распределение ролей',
                startGame: 'Начать игру',
                introductionTitle: 'Знакомство с ролями',
                player: 'Игрок: <span id="currentPlayerName"></span>',
                flipCard: 'Перевернуть карту',
                continue: 'Продолжить',
                day: 'День',
                night: 'Ночь',
                citySleeps: 'Город засыпает',
                cityWakes: 'Город просыпается',
                dayDiscussion: 'Дневное обсуждение',
                alivePlayers: 'Живые игроки',
                gameLog: 'Лог событий',
                deadPlayers: 'Мертвые и изгнанные',
                endGame: 'Завершить игру',
                confirmTitle: 'Подтверждение',
                confirmDescription: 'Вы уверены, что хотите завершить игру?',
                no: 'Нет',
                yes: 'Да',
                votingTitle: 'Голосование',
                votingDescription: 'Выберите игрока для изгнания (или пропустите):',
                skip: 'Пропустить',
                confirm: 'Подтвердить',
                nightResultsTitle: 'Результаты ночи',
                witnessSecondTitle: 'Повторное действие Свидетеля',
                witnessSleeps: 'Свидетель засыпает',
                selectVote: 'Выберите игрока для действия!',
                playerNamePlaceholder: 'Имя игрока',
                playerOne: 'игрок',
                playerFew: 'игрока',
                playerMany: 'игроков',
                lover: 'Любовница',
                mafia: 'Мафия',
                don: 'Дон',
                sheriff: 'Шериф',
                doctor: 'Доктор',
                maniac: 'Маньяк',
                witness: 'Свидетель',
                civilian: 'Мирный',
                loverAction: 'Просыпается Любовница',
                witnessAction: 'Просыпается Свидетель',
                mafiaAction: 'Просыпается Мафия',
                donAction: 'Просыпается Дон',
                sheriffAction: 'Просыпается Шериф',
                doctorAction: 'Просыпается Доктор',
                maniacAction: 'Просыпается Маньяк',
                witnessSecondAction: 'Просыпается Свидетель (повторно)',
                loverSleeps: 'Любовница засыпает',
                mafiaSleeps: 'Мафия засыпает',
                donSleeps: 'Дон засыпает',
                sheriffSleeps: 'Шериф засыпает',
                doctorSleeps: 'Доктор засыпает',
                maniacSleeps: 'Маньяк засыпает',
                blockedByLover: 'Заблокировано Любовницей',
                killedByMafia: 'Убит (Мафия)',
                killedByManiac: 'Убит (Маньяк)',
                killedWithLover: 'Убита (Любовница)',
                exiled: 'Изгнан',
                loverAlibi: 'имеет алиби от Любовницы и остается в игре',
                votingSkipped: 'Голосование пропущено, никого не изгнано',
                civiliansWin: 'Мирные жители победили!',
                mafiaWins: 'Мафия победила!',
                maniacWins: 'Маньяк победил!',
                footer: 'Игра "Мафия" © 2025 | Система для ведущего'
            }
        };

        const elements = {
            app: document.getElementById('app'),
            setupScreen: document.getElementById('setupScreen'),
            introductionScreen: document.getElementById('introductionScreen'),
            gameScreen: document.getElementById('gameScreen'),
            playerNameInput: document.getElementById('playerNameInput'),
            addPlayerBtn: document.getElementById('addPlayerBtn'),
            playersList: document.getElementById('playersList'),
            playersCount: document.getElementById('playersCount'),
            rolesSelection: document.getElementById('rolesSelection'),
            startGameBtn: document.getElementById('startGameBtn'),
            currentPlayerName: document.getElementById('currentPlayerName'),
            continueIntroBtn: document.getElementById('continueIntroBtn'),
            gamePhaseTitle: document.getElementById('gamePhaseTitle'),
            actionTitle: document.getElementById('actionTitle'),
            actionDescription: document.getElementById('actionDescription'),
            actionProgress: document.getElementById('actionProgress'),
            nextPhaseBtn: document.getElementById('nextPhaseBtn'),
            btnPhaseText: document.getElementById('btnPhaseText'),
            btnPhaseIcon: document.getElementById('btnPhaseIcon'),
            alivePlayers: document.getElementById('alivePlayers'),
            aliveCount: document.getElementById('aliveCount'),
            deadPlayers: document.getElementById('deadPlayers'),
            deadCount: document.getElementById('deadCount'),
            gameLog: document.getElementById('gameLog'),
            endGameBtn: document.getElementById('endGameBtn'),
            confirmModal: document.getElementById('confirmModal'),
            confirmCancel: document.getElementById('confirmCancel'),
            confirmEnd: document.getElementById('confirmEnd'),
            votingModal: document.getElementById('votingModal'),
            votingPlayers: document.getElementById('votingPlayers'),
            votingConfirmBtn: document.getElementById('votingConfirmBtn'),
            votingSkipBtn: document.getElementById('votingSkipBtn'),
            nightResultsModal: document.getElementById('nightResultsModal'),
            nightResults: document.getElementById('nightResults'),
            nightResultsConfirmBtn: document.getElementById('nightResultsConfirmBtn'),
            witnessSecondActionModal: document.getElementById('witnessSecondActionModal'),
            witnessSecondResult: document.getElementById('witnessSecondResult'),
            witnessSecondActionConfirmBtn: document.getElementById('witnessSecondActionConfirmBtn'),
            changeLanguageBtn: document.getElementById('changeLanguageBtn'),
            languageLabel: document.getElementById('languageLabel')
        };

        function setupEventListeners() {
            elements.addPlayerBtn.addEventListener('click', addPlayer);
            elements.startGameBtn.addEventListener('click', startGame);
            elements.continueIntroBtn.addEventListener('click', continueIntroduction);
            elements.nextPhaseBtn.addEventListener('click', nextPhase);
            elements.endGameBtn.addEventListener('click', () => {
                elements.confirmModal.style.display = 'block';
            });
            elements.confirmCancel.addEventListener('click', () => {
                elements.confirmModal.style.display = 'none';
            });
            elements.confirmEnd.addEventListener('click', endGame);
            elements.changeLanguageBtn.addEventListener('click', changeLanguage);

            document.querySelectorAll('.modal .close').forEach(closeBtn => {
                closeBtn.addEventListener('click', () => {
                    closeBtn.closest('.modal').style.display = 'none';
                });
            });
        }

        function changeLanguage() {
            gameState.currentLanguage = gameState.currentLanguage === 'uk' ? 'ru' : 'uk';
            elements.languageLabel.textContent = gameState.currentLanguage.toUpperCase();
            updateLanguage();
            saveState();
        }

        function updateLanguage() {
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.dataset.i18n;
                let text = translations[gameState.currentLanguage][key] || '';
                if (key === 'player') {
                    const playerName = elements.currentPlayerName.textContent;
                    text = text.replace('<span id="currentPlayerName"></span>', playerName);
                }
                element.innerHTML = text;
            });
            document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
                element.placeholder = translations[gameState.currentLanguage][element.dataset.i18nPlaceholder];
            });
            document.title = translations[gameState.currentLanguage].gameTitle;
            renderRolesSelection();
            renderPlayers();
            if (gameState.currentPhase === 'introduction') {
                renderIntroduction();
            } else if (gameState.currentPhase === 'game') {
                if (gameState.isDay) startDayPhase();
                else startNightPhase();
            }
            renderGameLog();
        }

        function addPlayer() {
            const name = elements.playerNameInput.value.trim();
            if (name && !gameState.players.some(p => p.name === name)) {
                gameState.players.push({ name, status: 'alive', role: null });
                renderPlayers();
                elements.playerNameInput.value = '';
                updateRolesInputs();
                saveState();
            } else {
                alert(translations[gameState.currentLanguage].selectVote);
            }
        }

        function updateStartGameButton() {
            const totalRoles = Object.values(gameState.roles).reduce((sum, count) => sum + count, 0);
            elements.startGameBtn.disabled = totalRoles !== gameState.players.length;
        }

        function renderPlayers() {
            elements.playersList.innerHTML = gameState.players.map((player, index) => `
                <div class="player-card bg-gray-700 p-3 rounded-lg flex justify-between items-center">
                    <span>${player.name}</span>
                    <button class="text-red-500 hover:text-red-400" onclick="gameState.players.splice(${index}, 1); renderPlayers(); updateRolesInputs(); saveState();">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `).join('');
            elements.playersCount.textContent = `${gameState.players.length} ${declinePlayers(gameState.players.length)}`;
            updateStartGameButton();
        }

        function renderRolesSelection() {
            elements.rolesSelection.innerHTML = rolesData.map(role => `
                <div class="flex items-center justify-between bg-gray-700 p-3 rounded-lg">
                    <div class="flex items-center">
                        <img src="${role.profileImage}" class="w-8 h-8 rounded-full mr-3">
                        <span>${translations[gameState.currentLanguage][role.id]}</span>
                    </div>
                    <div class="flex items-center">
                        <button data-role="${role.id}" data-action="decrease" class="w-8 h-8 bg-gray-600 hover:bg-gray-500 rounded-l-lg flex items-center justify-center">
                            <i class="fas fa-minus"></i>
                        </button>
                        <span id="${role.id}Count" class="role-quantity">${gameState.roles[role.id]}</span>
                        <button data-role="${role.id}" data-action="increase" class="w-8 h-8 bg-gray-600 hover:bg-gray-500 rounded-r-lg flex items-center justify-center">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
            `).join('');

            elements.rolesSelection.querySelectorAll('[data-role]').forEach(button => {
                button.addEventListener('click', () => {
                    const role = button.dataset.role;
                    const action = button.dataset.action;
                    const countSpan = document.getElementById(`${role}Count`);
                    let count = parseInt(countSpan.textContent);
                    if (action === 'increase' && count < gameState.players.length) count++;
                    if (action === 'decrease' && count > 0) count--;
                    countSpan.textContent = count;
                    gameState.roles[role] = count;
                    updateStartGameButton();
                    saveState();
                });
            });
        }

        function updateRolesInputs() {
            Object.keys(gameState.roles).forEach(role => {
                const countSpan = document.getElementById(`${role}Count`);
                if (countSpan) countSpan.textContent = gameState.roles[role];
            });
        }

        function startGame() {
            const totalRoles = Object.values(gameState.roles).reduce((sum, count) => sum + count, 0);
            if (totalRoles !== gameState.players.length) {
                alert(translations[gameState.currentLanguage].selectVote);
                return;
            }
            assignRoles();
            gameState.currentPhase = 'introduction';
            gameState.currentPlayerIndex = 0;
            switchScreen('introduction');
            renderIntroduction();
            saveState();
        }

        function assignRoles() {
            const rolesArray = [];
            Object.entries(gameState.roles).forEach(([role, count]) => {
                for (let i = 0; i < count; i++) {
                    const roleData = rolesData.find(r => r.id === role);
                    rolesArray.push({ ...roleData, name: translations[gameState.currentLanguage][role] });
                }
            });
            shuffle(rolesArray);
            gameState.players.forEach((player, index) => {
                player.role = rolesArray[index];
            });
        }

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function switchScreen(screen) {
            elements.setupScreen.classList.add('hidden');
            elements.introductionScreen.classList.add('hidden');
            elements.gameScreen.classList.add('hidden');
            if (screen === 'setup') elements.setupScreen.classList.remove('hidden');
            if (screen === 'introduction') elements.introductionScreen.classList.remove('hidden');
            if (screen === 'game') elements.gameScreen.classList.remove('hidden');
        }

        function renderIntroduction() {
            if (gameState.currentPlayerIndex >= gameState.players.length) {
                gameState.currentPhase = 'game';
                gameState.isDay = true;
                gameState.currentDay = 1;
                switchScreen('game');
                startDayPhase();
                return;
            }
            const player = gameState.players[gameState.currentPlayerIndex];
            elements.currentPlayerName.textContent = player.name;
            elements.continueIntroBtn.textContent = translations[gameState.currentLanguage].flipCard;
            elements.continueIntroBtn.disabled = false;
            const card = document.querySelector('.card');
            const cardFront = document.querySelector('.card-front');
            cardFront.style.backgroundImage = '';
            card.classList.remove('flipped');
            updateLanguage();
        }

        function continueIntroduction() {
            const card = document.querySelector('.card');
            const cardFront = document.querySelector('.card-front');
            const player = gameState.players[gameState.currentPlayerIndex];

            if (!card.classList.contains('flipped')) {
                cardFront.style.backgroundImage = `url('${player.role.cardImage}')`;
                card.classList.add('flipped');
                elements.continueIntroBtn.textContent = translations[gameState.currentLanguage].continue;
            } else {
                card.classList.remove('flipped');
                elements.continueIntroBtn.disabled = true;
                const onTransitionEnd = () => {
                    card.removeEventListener('transitionend', onTransitionEnd);
                    cardFront.style.backgroundImage = '';
                    gameState.currentPlayerIndex++;
                    renderIntroduction();
                    saveState();
                };
                card.addEventListener('transitionend', onTransitionEnd);
            }
        }

        function startDayPhase() {
            gameState.isDay = true;
            elements.gamePhaseTitle.innerHTML = `<i class="fas fa-sun mr-2"></i>${translations[gameState.currentLanguage].day} ${gameState.currentDay}`;
            elements.btnPhaseText.textContent = translations[gameState.currentLanguage].citySleeps;
            elements.btnPhaseIcon.className = 'fas fa-moon ml-2';
            gameState.voting = [];
            gameState.selectedPlayer = null;

            if (gameState.currentDay > 1) {
                showNightResults();
            } else {
                startDayDiscussion();
            }
            renderPlayersStatus();
            renderGameLog();
            checkGameEnd();
        }

        function startDayDiscussion() {
            elements.actionTitle.innerHTML = `<i class="fas fa-sun mr-2"></i>${translations[gameState.currentLanguage].dayDiscussion}`;
            elements.actionDescription.textContent = translations[gameState.currentLanguage].dayDiscussion + '. ' + translations[gameState.currentLanguage].votingDescription.split(':')[0] + '.';
            renderPlayersStatus();
        }

        function showNightResults() {
            const modal = elements.nightResultsModal;
            const resultsContainer = elements.nightResults;
            const confirmBtn = elements.nightResultsConfirmBtn;

            const killedPlayers = gameState.players
                .filter(p => p.status === 'dead' && p.deathTime === `${translations[gameState.currentLanguage].night} ${gameState.currentNight}`)
                .map(p => p.name);

            resultsContainer.innerHTML = killedPlayers.length > 0
                ? `<p>${translations[gameState.currentLanguage].killedByMafia}: "${killedPlayers.join('", "')}"</p>`
                : `<p>${translations[gameState.currentLanguage].votingSkipped.split(',')[0]}.</p>`;

            modal.style.display = 'block';

            confirmBtn.onclick = () => {
                modal.style.display = 'none';
                gameState.nightResults = [];
                startDayDiscussion();
                saveState();
            };

            modal.querySelector('.close').onclick = () => {
                modal.style.display = 'none';
                gameState.nightResults = [];
                startDayDiscussion();
                saveState();
            };
        }

        function renderPlayersStatus() {
            const alivePlayers = gameState.players.filter(p => p.status === 'alive');
            elements.alivePlayers.innerHTML = alivePlayers.map(player => `
                <div class="player-profile ${gameState.voting.includes(player.name) || gameState.selectedPlayer === player.name ? 'selected-player' : ''}" 
                    data-name="${player.name}">
                    <img src="${player.role.profileImage}" alt="${player.role.name}">
                    <div class="name">${player.name}</div>
                    <div class="role">${translations[gameState.currentLanguage][player.role.id]}</div>
                </div>
            `).join('');
            elements.deadPlayers.innerHTML = gameState.players.filter(p => p.status !== 'alive').map(player => `
                <div class="player-profile dead-player">
                    <img src="${player.role.profileImage}" alt="${player.role.name}">
                    <div class="name">${player.name}</div>
                    <div class="role">${translations[gameState.currentLanguage][player.role.id]}</div>
                    <div class="status">${translations[gameState.currentLanguage][player.deathReason.toLowerCase()] || player.deathReason}, ${player.deathTime.replace(translations[gameState.currentLanguage].night, translations[gameState.currentLanguage].night).replace(translations[gameState.currentLanguage].day, translations[gameState.currentLanguage].day)}</div>
                </div>
            `).join('');
            elements.aliveCount.textContent = `${alivePlayers.length} ${declinePlayers(alivePlayers.length)}`;
            elements.deadCount.textContent = `${gameState.players.filter(p => p.status !== 'alive').length} ${declinePlayers(gameState.players.filter(p => p.status !== 'alive').length)}`;
            elements.actionProgress.textContent = gameState.isDay ? `${gameState.voting.length}/${alivePlayers.length}` : '';

            elements.alivePlayers.querySelectorAll('.player-profile').forEach(profile => {
                profile.addEventListener('click', () => {
                    const name = profile.dataset.name;
                    if (gameState.isDay) {
                        if (gameState.voting.includes(name)) {
                            gameState.voting = gameState.voting.filter(n => n !== name);
                        } else {
                            gameState.voting.push(name);
                        }
                        if (gameState.voting.length >= 2) {
                            openVotingModal();
                        }
                    } else {
                        const currentRole = getCurrentNightRole();
                        const validTargets = getValidTargets(currentRole);
                        if (validTargets.some(p => p.name === name)) {
                            gameState.selectedPlayer = gameState.selectedPlayer === name ? null : name;
                        }
                    }
                    renderPlayersStatus();
                    saveState();
                });
            });
        }

        function openVotingModal() {
            const votingModal = elements.votingModal;
            const votingPlayers = elements.votingPlayers;
            const candidates = gameState.voting;
            let selectedPlayer = null;

            votingPlayers.innerHTML = candidates.map(name => `
                <div class="player-card bg-gray-700 p-3 rounded-lg cursor-pointer hover:scale-105" 
                    data-name="${name}">
                    <div class="text-center">
                        <img src="${gameState.players.find(p => p.name === name).role.profileImage}" class="w-12 h-12 rounded-full mx-auto mb-2">
                        <div class="font-medium">${name}</div>
                        <div class="text-xs text-gray-400">${translations[gameState.currentLanguage][gameState.players.find(p => p.name === name).role.id]}</div>
                    </div>
                </div>
            `).join('');
            votingModal.style.display = 'block';

            votingPlayers.querySelectorAll('.player-card').forEach(card => {
                card.addEventListener('click', () => {
                    const name = card.dataset.name;
                    votingPlayers.querySelectorAll('.player-card').forEach(c => c.classList.remove('selected-player'));
                    card.classList.add('selected-player');
                    selectedPlayer = name;
                });
            });

            elements.votingConfirmBtn.onclick = () => {
                if (selectedPlayer) {
                    const player = gameState.players.find(p => p.name === selectedPlayer);
                    if (player.role.id === 'lover') {
                        logGameEvent(`${translations[gameState.currentLanguage].day} ${gameState.currentDay}: ${player.name} ${translations[gameState.currentLanguage].loverAlibi}.`);
                        gameState.nightResults.push(`${player.name} ${translations[gameState.currentLanguage].loverAlibi}.`);
                    } else {
                        player.status = 'exiled';
                        player.deathReason = translations[gameState.currentLanguage].exiled;
                        player.deathTime = `${translations[gameState.currentLanguage].day} ${gameState.currentDay}`;
                        logGameEvent(`${translations[gameState.currentLanguage].day} ${gameState.currentDay}: ${player.name} ${translations[gameState.currentLanguage].exiled.toLowerCase()}.`);
                        gameState.nightResults.push(`${player.name} ${translations[gameState.currentLanguage].exiled.toLowerCase()}.`);
                    }
                    votingModal.style.display = 'none';
                    gameState.voting = [];
                    renderPlayersStatus();
                    checkGameEnd();
                    saveState();
                } else {
                    alert(translations[gameState.currentLanguage].selectVote);
                }
            };

            elements.votingSkipBtn.onclick = () => {
                logGameEvent(`${translations[gameState.currentLanguage].day} ${gameState.currentDay}: ${translations[gameState.currentLanguage].votingSkipped}.`);
                gameState.nightResults.push(translations[gameState.currentLanguage].votingSkipped);
                votingModal.style.display = 'none';
                gameState.voting = [];
                renderPlayersStatus();
                saveState();
            };

            votingModal.querySelector('.close').onclick = () => {
                votingModal.style.display = 'none';
                gameState.voting = [];
                renderPlayersStatus();
                saveState();
            };
        }

        function getCurrentNightRole() {
            const nightActions = [
                { role: 'lover', description: translations[gameState.currentLanguage].loverAction, buttonText: translations[gameState.currentLanguage].loverSleeps },
                { role: 'witness', description: translations[gameState.currentLanguage].witnessAction, buttonText: translations[gameState.currentLanguage].witnessSleeps },
                { role: 'mafia', description: translations[gameState.currentLanguage].mafiaAction, buttonText: translations[gameState.currentLanguage].mafiaSleeps },
                { role: 'don', description: translations[gameState.currentLanguage].donAction, buttonText: translations[gameState.currentLanguage].donSleeps },
                { role: 'sheriff', description: translations[gameState.currentLanguage].sheriffAction, buttonText: translations[gameState.currentLanguage].sheriffSleeps },
                { role: 'doctor', description: translations[gameState.currentLanguage].doctorAction, buttonText: translations[gameState.currentLanguage].doctorSleeps },
                { role: 'maniac', description: translations[gameState.currentLanguage].maniacAction, buttonText: translations[gameState.currentLanguage].maniacSleeps },
                { role: 'witnessSecond', description: translations[gameState.currentLanguage].witnessSecondAction, buttonText: translations[gameState.currentLanguage].witnessSleeps }
            ];
            return nightActions[gameState.currentRoleIndex]?.role;
        }

        function getValidTargets(role) {
            const alivePlayers = gameState.players.filter(p => p.status === 'alive');
            if (role === 'lover') {
                return alivePlayers.filter(p => p.role.id !== 'lover' && p !== gameState.actions.loverLastNight);
            } else if (role === 'witness') {
                return alivePlayers.filter(p => p.role.id !== 'witness' && p !== gameState.actions.witnessLastNight);
            } else if (role === 'mafia') {
                return alivePlayers.filter(p => p.role.team !== 'mafia');
            } else if (role === 'don') {
                return alivePlayers.filter(p => p.role.id !== 'don' && p.role.id !== 'mafia');
            } else if (role === 'sheriff') {
                return alivePlayers.filter(p => p.role.id !== 'sheriff');
            } else if (role === 'doctor') {
                return alivePlayers.filter(p => p !== gameState.actions.doctorLastNight);
            } else if (role === 'maniac') {
                return alivePlayers.filter(p => p.role.id !== 'maniac');
            }
            return alivePlayers;
        }

        function logGameEvent(event) {
            gameState.gameLog.push(event);
            renderGameLog();
            saveState();
        }

        function renderGameLog() {
            elements.gameLog.innerHTML = gameState.gameLog.slice().reverse().map(event => `<p>${event}</p>`).join('');
            elements.gameLog.scrollTop = elements.gameLog.scrollHeight;
        }

        function openWitnessSecondActionModal() {
            const modal = elements.witnessSecondActionModal;
            const result = elements.witnessSecondResult;
            const confirmBtn = elements.witnessSecondActionConfirmBtn;
            const witnessTarget = gameState.actions.witness;
            const mafiaTarget = gameState.actions.mafia;
            const maniacTarget = gameState.actions.maniac;

            if (witnessTarget && (witnessTarget === mafiaTarget || witnessTarget === maniacTarget)) {
                const killer = witnessTarget === mafiaTarget ? translations[gameState.currentLanguage].mafia : translations[gameState.currentLanguage].maniac;
                result.textContent = `${translations[gameState.currentLanguage].witness} побачив, що ${witnessTarget} був атакований (${killer}).`;
                logGameEvent(`${translations[gameState.currentLanguage].night} ${gameState.currentNight}: ${translations[gameState.currentLanguage].witness} побачив, що ${witnessTarget} був атакований (${killer}).`);
                gameState.nightResults.push(`${translations[gameState.currentLanguage].witness} побачив, що ${witnessTarget} був атакований (${killer}).`);
            } else {
                result.textContent = `${translations[gameState.currentLanguage].witness} спостерігав за ${witnessTarget || translations[gameState.currentLanguage].nobody}, але нічого не сталося.`;
                logGameEvent(`${translations[gameState.currentLanguage].night} ${gameState.currentNight}: ${translations[gameState.currentLanguage].witness} спостерігав за ${witnessTarget || translations[gameState.currentLanguage].nobody}, але нічого не сталося.`);
                gameState.nightResults.push(`${translations[gameState.currentLanguage].witness} спостерігав за ${witnessTarget || translations[gameState.currentLanguage].nobody}, але нічого не сталося.`);
            }

            modal.style.display = 'block';
            elements.actionTitle.innerHTML = `<i class="fas fa-moon mr-2"></i>${translations[gameState.currentLanguage].witnessSecondAction}`;
            elements.btnPhaseText.textContent = translations[gameState.currentLanguage].witnessSleeps;
            elements.btnPhaseIcon.className = 'fas fa-moon ml-2';

            confirmBtn.onclick = () => {
                modal.style.display = 'none';
                gameState.currentRoleIndex++;
                startNightPhase();
                saveState();
            };

            modal.querySelector('.close').onclick = () => {
                modal.style.display = 'none';
                gameState.currentRoleIndex++;
                startNightPhase();
                saveState();
            };
        }

        function nextPhase() {
            if (gameState.isDay) {
                gameState.isDay = false;
                gameState.currentNight++;
                logGameEvent(`${translations[gameState.currentLanguage].citySleeps}: ${translations[gameState.currentLanguage].night.toLowerCase()} ${gameState.currentNight}.`);
                gameState.actions = {};
                gameState.currentRoleIndex = 0;
                gameState.selectedPlayer = null;
                startNightPhase();
            } else {
                const currentRole = getCurrentNightRole();
                const rolePlayer = currentRole !== 'witnessSecond' ? gameState.players.find(p => p.role.id === currentRole && p.status === 'alive') : null;
                const isBlocked = rolePlayer && gameState.actions.lover === rolePlayer.name && ['mafia', 'don', 'sheriff', 'doctor', 'maniac'].includes(currentRole);

                if (currentRole !== 'witnessSecond' && !isBlocked) {
                    gameState.actions[currentRole] = gameState.selectedPlayer;
                    if (currentRole === 'lover') gameState.actions.loverLastNight = gameState.selectedPlayer ? gameState.players.find(p => p.name === gameState.selectedPlayer) : null;
                    if (currentRole === 'witness') gameState.actions.witnessLastNight = gameState.selectedPlayer ? gameState.players.find(p => p.name === gameState.selectedPlayer) : null;
                    if (currentRole === 'doctor') gameState.actions.doctorLastNight = gameState.selectedPlayer ? gameState.players.find(p => p.name === gameState.selectedPlayer) : null;
                    processNightActions();
                }
                gameState.currentRoleIndex++;
                gameState.selectedPlayer = null;
                startNightPhase();
            }
            saveState();
        }

        function startNightPhase() {
            elements.gamePhaseTitle.innerHTML = `<i class="fas fa-moon mr-2"></i>${translations[gameState.currentLanguage].night} ${gameState.currentNight}`;
            elements.actionProgress.textContent = '';

            const nightActions = [
                { role: 'lover', description: translations[gameState.currentLanguage].loverAction, buttonText: translations[gameState.currentLanguage].loverSleeps },
                { role: 'witness', description: translations[gameState.currentLanguage].witnessAction, buttonText: translations[gameState.currentLanguage].witnessSleeps },
                { role: 'mafia', description: translations[gameState.currentLanguage].mafiaAction, buttonText: translations[gameState.currentLanguage].mafiaSleeps },
                { role: 'don', description: translations[gameState.currentLanguage].donAction, buttonText: translations[gameState.currentLanguage].donSleeps },
                { role: 'sheriff', description: translations[gameState.currentLanguage].sheriffAction, buttonText: translations[gameState.currentLanguage].sheriffSleeps },
                { role: 'doctor', description: translations[gameState.currentLanguage].doctorAction, buttonText: translations[gameState.currentLanguage].doctorSleeps },
                { role: 'maniac', description: translations[gameState.currentLanguage].maniacAction, buttonText: translations[gameState.currentLanguage].maniacSleeps },
                { role: 'witnessSecond', description: translations[gameState.currentLanguage].witnessSecondAction, buttonText: translations[gameState.currentLanguage].witnessSleeps }
            ];

            if (gameState.currentRoleIndex >= nightActions.length) {
                gameState.isDay = true;
                gameState.currentDay++;
                logGameEvent(`${translations[gameState.currentLanguage].cityWakes}: ${translations[gameState.currentLanguage].day.toLowerCase()} ${gameState.currentDay}.`);
                startDayPhase();
                return;
            }

            const action = nightActions[gameState.currentRoleIndex];
            const rolePlayer = action.role !== 'witnessSecond' ? gameState.players.find(p => p.role.id === action.role && p.status === 'alive') : null;
            const isBlocked = rolePlayer && gameState.actions.lover === rolePlayer.name && ['mafia', 'don', 'sheriff', 'doctor', 'maniac'].includes(action.role);

            if (isBlocked) {
                elements.actionTitle.innerHTML = `<i class="fas fa-moon mr-2"></i>${action.description} (${translations[gameState.currentLanguage].blockedByLover})`;
                elements.actionDescription.textContent = `${translations[gameState.currentLanguage].playerOne} із роллю ${translations[gameState.currentLanguage][action.role]} ${translations[gameState.currentLanguage].blockedByLover.toLowerCase()} і не може виконати дію цієї ночі. Натисніть "${action.buttonText}".`;
                elements.btnPhaseText.textContent = action.buttonText;
                elements.btnPhaseIcon.className = 'fas fa-moon ml-2';
                renderPlayersStatus();
            } else if (action.role === 'witnessSecond') {
                if (gameState.players.some(p => p.role.id === 'witness' && p.status === 'alive')) {
                    openWitnessSecondActionModal();
                } else {
                    gameState.currentRoleIndex++;
                    startNightPhase();
                }
            } else {
                elements.actionTitle.innerHTML = `<i class="fas fa-moon mr-2"></i>${action.description}`;
                elements.actionDescription.textContent = rolePlayer
                    ? `${translations[gameState.currentLanguage].votingDescription.split(':')[0]}.`
                    : `${translations[gameState.currentLanguage].role} ${translations[gameState.currentLanguage][action.role]} ${translations[gameState.currentLanguage].deadOrMissing}. Натисніть "${action.buttonText}".`;
                elements.btnPhaseText.textContent = action.buttonText;
                elements.btnPhaseIcon.className = 'fas fa-moon ml-2';
                renderPlayersStatus();
            }
        }

        function processNightActions() {
            const currentRole = getCurrentNightRole();
            if (!currentRole || currentRole === 'witnessSecond') return;

            const blockedPlayer = gameState.actions.lover;
            const mafiaTarget = gameState.actions.mafia;
            const maniacTarget = gameState.actions.maniac;
            const doctorTarget = gameState.actions.doctor;
            const sheriffTarget = gameState.actions.sheriff;
            const donTarget = gameState.actions.don;

            if (currentRole === 'lover' && blockedPlayer) {
                const blocked = gameState.players.find(p => p.name === blockedPlayer && p.status === 'alive');
                if (blocked) {
                    logGameEvent(`${translations[gameState.currentLanguage].night} ${gameState.currentNight}: ${blocked.name} ${translations[gameState.currentLanguage].blockedByLover.toLowerCase()}.`);
                    gameState.nightResults.push(`${blocked.name} ${translations[gameState.currentLanguage].blockedByLover.toLowerCase()}.`);
                    ['mafia', 'don', 'sheriff', 'doctor', 'maniac'].forEach(role => {
                        if (gameState.actions[role] === blocked.name) {
                            gameState.actions[role] = null;
                            logGameEvent(`${translations[gameState.currentLanguage].night} ${gameState.currentNight}: ${translations[gameState.currentLanguage].action} ${translations[gameState.currentLanguage][role]} ${translations[gameState.currentLanguage].blockedByLover.toLowerCase()}.`);
                            gameState.nightResults.push(`${translations[gameState.currentLanguage].action} ${translations[gameState.currentLanguage][role]} ${translations[gameState.currentLanguage].blockedByLover.toLowerCase()}.`);
                        }
                    });
                }
            }

            if (currentRole === 'mafia' && mafiaTarget && mafiaTarget !== doctorTarget) {
                const target = gameState.players.find(p => p.name === mafiaTarget && p.status === 'alive');
                if (target) {
                    if (target.role.id === 'lover') {
                        const lover = gameState.players.find(p => p.role.id === 'lover' && p.status === 'alive');
                        if (lover) {
                            lover.status = 'dead';
                            lover.deathReason = translations[gameState.currentLanguage].killedWithLover;
                            lover.deathTime = `${translations[gameState.currentLanguage].night} ${gameState.currentNight}`;
                            logGameEvent(`${translations[gameState.currentLanguage].night} ${gameState.currentNight}: ${lover.name} (${translations[gameState.currentLanguage].lover}) ${translations[gameState.currentLanguage].killedWithLover.toLowerCase()} разом із ${target.name}.`);
                            gameState.nightResults.push(`${lover.name} (${translations[gameState.currentLanguage].lover}) ${translations[gameState.currentLanguage].killedWithLover.toLowerCase()} разом із ${target.name}.`);
                        }
                    }
                    target.status = 'dead';
                    target.deathReason = translations[gameState.currentLanguage].killedByMafia;
                    target.deathTime = `${translations[gameState.currentLanguage].night} ${gameState.currentNight}`;
                    logGameEvent(`${translations[gameState.currentLanguage].night} ${gameState.currentNight}: ${target.name} ${translations[gameState.currentLanguage].killedByMafia.toLowerCase()}.`);
                    gameState.nightResults.push(`${target.name} ${translations[gameState.currentLanguage].killedByMafia.toLowerCase()}.`);
                }
            } else if (currentRole === 'mafia' && mafiaTarget && mafiaTarget === doctorTarget) {
                logGameEvent(`${translations[gameState.currentLanguage].night} ${gameState.currentNight}: ${translations[gameState.currentLanguage].doctor} врятував ${mafiaTarget} від ${translations[gameState.currentLanguage].mafia}.`);
                gameState.nightResults.push(`${translations[gameState.currentLanguage].night} ${gameState.currentNight}: ${translations[gameState.currentLanguage].doctor} врятував ${mafiaTarget} від ${translations[gameState.currentLanguage].mafia}.`);
            }

            if (currentRole === 'maniac' && maniacTarget && maniacTarget !== doctorTarget) {
                const target = gameState.players.find(p => p.name === maniacTarget && p.status === 'alive');
                if (target) {
                    if (target.role.id === 'lover') {
                        const lover = gameState.players.find(p => p.role.id === 'lover' && p.status === 'alive');
                        if (lover) {
                            lover.status = 'dead';
                            lover.deathReason = translations[gameState.currentLanguage].killedWithLover;
                            lover.deathTime = `${translations[gameState.currentLanguage].night} ${gameState.currentNight}`;
                            logGameEvent(`${translations[gameState.currentLanguage].night} ${gameState.currentNight}: ${lover.name} (${translations[gameState.currentLanguage].lover}) ${translations[gameState.currentLanguage].killedWithLover.toLowerCase()} разом із ${target.name}.`);
                            gameState.nightResults.push(`${lover.name} (${translations[gameState.currentLanguage].lover}) ${translations[gameState.currentLanguage].killedWithLover.toLowerCase()} разом із ${target.name}.`);
                        }
                    }
                    target.status = 'dead';
                    target.deathReason = translations[gameState.currentLanguage].killedByManiac;
                    target.deathTime = `${translations[gameState.currentLanguage].night} ${gameState.currentNight}`;
                    logGameEvent(`${translations[gameState.currentLanguage].night} ${gameState.currentNight}: ${target.name} ${translations[gameState.currentLanguage].killedByManiac.toLowerCase()}.`);
                    gameState.nightResults.push(`${target.name} ${translations[gameState.currentLanguage].killedByManiac.toLowerCase()}.`);
                }
            } else if (currentRole === 'maniac' && maniacTarget && maniacTarget === doctorTarget) {
                logGameEvent(`${translations[gameState.currentLanguage].night} ${gameState.currentNight}: ${translations[gameState.currentLanguage].doctor} врятував ${maniacTarget} від ${translations[gameState.currentLanguage].maniac}.`);
                gameState.nightResults.push(`${translations[gameState.currentLanguage].night} ${gameState.currentNight}: ${translations[gameState.currentLanguage].doctor} врятував ${maniacTarget} від ${translations[gameState.currentLanguage].maniac}.`);
            }

            if (currentRole === 'sheriff' && sheriffTarget) {
                const target = gameState.players.find(p => p.name === sheriffTarget && p.status === 'alive');
                if (target) {
                    const isMafia = target.role.team === 'mafia';
                    logGameEvent(`${translations[gameState.currentLanguage].night} ${gameState.currentNight}: ${translations[gameState.currentLanguage].sheriff} перевірив ${target.name}: ${isMafia ? translations[gameState.currentLanguage].mafia : translations[gameState.currentLanguage].notMafia}.`);
                    gameState.nightResults.push(`${translations[gameState.currentLanguage].night} ${gameState.currentNight}: ${translations[gameState.currentLanguage].sheriff} перевірив ${target.name}: ${isMafia ? translations[gameState.currentLanguage].mafia : translations[gameState.currentLanguage].notMafia}.`);
                }
            }

            if (currentRole === 'don' && donTarget) {
                const target = gameState.players.find(p => p.name === donTarget && p.status === 'alive');
                if (target) {
                    const isSheriff = target.role.id === 'sheriff';
                    logGameEvent(`${translations[gameState.currentLanguage].night} ${gameState.currentNight}: ${translations[gameState.currentLanguage].don} перевірив ${target.name}: ${isSheriff ? translations[gameState.currentLanguage].sheriff : translations[gameState.currentLanguage].notSheriff}.`);
                    gameState.nightResults.push(`${translations[gameState.currentLanguage].night} ${gameState.currentNight}: ${translations[gameState.currentLanguage].don} перевірив ${target.name}: ${isSheriff ? translations[gameState.currentLanguage].sheriff : translations[gameState.currentLanguage].notSheriff}.`);
                }
            }
        }

        function checkGameEnd() {
            const alivePlayers = gameState.players.filter(p => p.status === 'alive');
            const mafiaCount = alivePlayers.filter(p => p.role.team === 'mafia').length;
            const civilianCount = alivePlayers.filter(p => p.role.team === 'civilian').length;
            const maniacCount = alivePlayers.filter(p => p.role.id === 'maniac').length;

            if (mafiaCount === 0 && maniacCount === 0) {
                logGameEvent(translations[gameState.currentLanguage].civiliansWin);
                alert(translations[gameState.currentLanguage].civiliansWin);
                endGame();
            } else if (mafiaCount >= civilianCount && maniacCount === 0) {
                logGameEvent(translations[gameState.currentLanguage].mafiaWins);
                alert(translations[gameState.currentLanguage].mafiaWins);
                endGame();
            } else if (maniacCount === 1 && alivePlayers.length === 2 && mafiaCount === 0) {
                logGameEvent(translations[gameState.currentLanguage].maniacWins);
                alert(translations[gameState.currentLanguage].maniacWins);
                endGame();
            }
        }

        function endGame() {
            gameState.savedPlayers = gameState.players.map(p => ({ name: p.name }));
            gameState.savedRoles = { ...gameState.roles };
            gameState.currentPhase = 'setup';
            gameState.players = gameState.savedPlayers.map(p => ({ ...p, status: 'alive', role: null }));
            gameState.roles = { ...gameState.savedRoles };
            gameState.currentDay = 1;
            gameState.currentNight = 0;
            gameState.isDay = true;
            gameState.actions = {};
            gameState.voting = [];
            gameState.currentPlayerIndex = 0;
            gameState.currentRoleIndex = 0;
            gameState.gameLog = [];
            gameState.selectedPlayer = null;
            gameState.nightResults = [];
            switchScreen('setup');
            renderPlayers();
            renderRolesSelection();
            elements.confirmModal.style.display = 'none';
            saveState();
            updateLanguage();
        }

        function declinePlayers(count) {
            if (count === 1) return translations[gameState.currentLanguage].playerOne;
            if (count >= 2 && count <= 4) return translations[gameState.currentLanguage].playerFew;
            return translations[gameState.currentLanguage].playerMany;
        }

        function saveState() {
            localStorage.setItem('mafiaGameState', JSON.stringify(gameState));
        }

        function loadState() {
            const savedState = localStorage.getItem('mafiaGameState');
            if (savedState) {
                Object.assign(gameState, JSON.parse(savedState));
                elements.languageLabel.textContent = gameState.currentLanguage.toUpperCase();
                switchScreen(gameState.currentPhase);
                if (gameState.currentPhase === 'setup') {
                    renderPlayers();
                    renderRolesSelection();
                } else if (gameState.currentPhase === 'introduction') {
                    renderIntroduction();
                } else {
                    if (gameState.isDay) {
                        startDayPhase();
                    } else {
                        startNightPhase();
                    }
                }
                updateLanguage();
            } else {
                renderRolesSelection();
                updateLanguage();
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            loadState();
        });
    </script>
</body>
    </html>
