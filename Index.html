<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Мафія - Ведучий</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #121212;
            color: #f5f5f5;
            transition: all 0.3s ease;
        }

        .player-card {
            transition: all 0.3s ease;
        }

        .player-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }

        .role-quantity {
            min-width: 30px;
            text-align: center;
        }

        .selected-player {
            animation: pulse 2s infinite;
            box-shadow: 0 0 0 3px rgba(74, 222, 128, 0.7);
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(74, 222, 128, 0); }
            100% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0); }
        }

        .dead-player, .exiled-player {
            opacity: 0.6;
            background-color: #4a5568 !important;
        }

        .card-container {
            perspective: 1000px;
            width: 300px;
            height: 450px;
            margin: 20px auto;
            cursor: pointer;
            user-select: none;
        }

        .card {
            position: relative;
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
            transition: transform 0.6s;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .card.flipped {
            transform: rotateY(180deg);
        }

        .card-front,
        .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 15px;
            background-size: cover;
            background-position: center;
        }

        .card-back {
            background-image: url('img/CARD.png');
        }

        .card-front {
            transform: rotateY(180deg);
        }

        .player-profile {
            text-align: center;
            background-color: #374151;
            padding: 12px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .player-profile img {
            width: 48px;
            height: 48px;
            border-radius: 9999px;
            object-fit: cover;
            margin-left: auto;
            margin-right: auto;
            margin-bottom: 8px;
        }

        .player-profile .name {
            font-size: 1.125rem;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .player-profile .role {
            font-size: 0.875rem;
            color: #9ca3af;
            text-transform: lowercase;
            margin-bottom: 4px;
        }

        .player-profile .status {
            font-size: 0.75rem;
            color: #9ca3af;
        }

        .scrollbar-custom::-webkit-scrollbar {
            width: 8px;
        }

        .scrollbar-custom::-webkit-scrollbar-track {
            background: #2d3748;
            border-radius: 4px;
        }

        .scrollbar-custom::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 4px;
        }

        .scrollbar-custom::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }
    </style>
    <link rel="preload" href="img/CARD.png" as="image">
    <link rel="preload" href="img/C LOVER.jpg" as="image">
    <link rel="preload" href="img/C MAFIA.jpg" as="image">
    <link rel="preload" href="img/C DON.png" as="image">
    <link rel="preload" href="img/C SHERIFF.png" as="image">
    <link rel="preload" href="img/C DOCTOR.png" as="image">
    <link rel="preload" href="img/C MANIAC.png" as="image">
    <link rel="preload" href="img/C WITNESS.jpg" as="image">
    <link rel="preload" href="img/C CIVILIAN.jpg" as="image">
    <link rel="preload" href="img/P LOVER.png" as="image">
    <link rel="preload" href="img/P MAFIA.png" as="image">
    <link rel="preload" href="img/P DON.png" as="image">
    <link rel="preload" href="img/P SHERIFF.png" as="image">
    <link rel="preload" href="img/P DOCTOR.png" as="image">
    <link rel="preload" href="img/P MANIAC.png" as="image">
    <link rel="preload" href="img/P WITNESS.png" as="image">
    <link rel="preload" href="img/P CIVILIAN.png" as="image">
</head>
<body class="min-h-screen flex flex-col">
    <!-- Модальне вікно підтвердження -->
    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 p-6 rounded-lg w-80">
            <h3 class="text-xl font-bold mb-4 text-center">Підтвердження</h3>
            <p class="mb-6 text-center">Ви впевнені, що хочете завершити гру?</p>
            <div class="flex justify-center space-x-4">
                <button id="confirmCancel" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded transition">Ні</button>
                <button id="confirmEnd" class="px-4 py-2 bg-red-600 hover:bg-red-500 rounded transition">Так</button>
            </div>
        </div>
    </div>

    <!-- Основний контейнер -->
    <div class="container mx-auto px-4 py-8 flex-grow">
        <header class="flex justify-center items-center mb-8">
            <h1 class="text-3xl font-bold text-center text-white">
                <i class="fas fa-user-secret mr-2"></i>Мафія - Ведучий
            </h1>
        </header>

        <div id="app" class="transition-all duration-300">
            <!-- Екран налаштування -->
            <div id="setupScreen">
                <h2 class="text-2xl font-semibold mb-6 text-center">Налаштування гри</h2>

                <!-- Додавання гравців -->
                <div class="bg-gray-800 rounded-lg p-6 mb-8 shadow-lg">
                    <h3 class="text-xl font-medium mb-4 flex items-center justify-between">
                        <span><i class="fas fa-users mr-2"></i>Гравці</span>
                        <span class="text-sm font-normal" id="playersCount">0 гравців</span>
                    </h3>
                    <div class="flex mb-4">
                        <input type="text" id="playerNameInput" placeholder="Ім'я гравця"
                               class="flex-grow px-4 py-2 bg-gray-700 border border-gray-600 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <button id="addPlayerBtn" class="px-4 py-2 bg-purple-600 hover:bg-purple-500 text-white rounded-r-lg transition-transform transform hover:scale-105">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div id="playersList" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3">
                        <!-- Гравці -->
                    </div>
                </div>

                <!-- Вибір ролей -->
                <div class="bg-gray-800 rounded-lg p-6 shadow-lg">
                    <h3 class="text-xl font-medium mb-4 flex items-center">
                        <i class="fas fa-mask mr-2"></i>Розподіл ролей
                    </h3>
                    <div id="rolesSelection" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <!-- Ролі -->
                        <div class="flex items-center justify-between bg-gray-700 p-3 rounded-lg">
                            <div class="flex items-center">
                                <img src="img/P MAFIA.png" class="w-8 h-8 rounded-full mr-3">
                                <span>Мафія</span>
                            </div>
                            <div class="flex items-center">
                                <button data-role="mafia" data-action="decrease" class="w-8 h-8 bg-gray-600 hover:bg-gray-500 rounded-l-lg flex items-center justify-center">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <span id="mafiaCount" class="role-quantity">0</span>
                                <button data-role="mafia" data-action="increase" class="w-8 h-8 bg-gray-600 hover:bg-gray-500 rounded-r-lg flex items-center justify-center">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="flex items-center justify-between bg-gray-700 p-3 rounded-lg">
                            <div class="flex items-center">
                                <img src="img/P DON.png" class="w-8 h-8 rounded-full mr-3">
                                <span>Дон</span>
                            </div>
                            <div class="flex items-center">
                                <button data-role="don" data-action="decrease" class="w-8 h-8 bg-gray-600 hover:bg-gray-500 rounded-l-lg flex items-center justify-center">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <span id="donCount" class="role-quantity">0</span>
                                <button data-role="don" data-action="increase" class="w-8 h-8 bg-gray-600 hover:bg-gray-500 rounded-r-lg flex items-center justify-center">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="flex items-center justify-between bg-gray-700 p-3 rounded-lg">
                            <div class="flex items-center">
                                <img src="img/P SHERIFF.png" class="w-8 h-8 rounded-full mr-3">
                                <span>Шериф</span>
                            </div>
                            <div class="flex items-center">
                                <button data-role="sheriff" data-action="decrease" class="w-8 h-8 bg-gray-600 hover:bg-gray-500 rounded-l-lg flex items-center justify-center">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <span id="sheriffCount" class="role-quantity">0</span>
                                <button data-role="sheriff" data-action="increase" class="w-8 h-8 bg-gray-600 hover:bg-gray-500 rounded-r-lg flex items-center justify-center">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="flex items-center justify-between bg-gray-700 p-3 rounded-lg">
                            <div class="flex items-center">
                                <img src="img/P DOCTOR.png" class="w-8 h-8 rounded-full mr-3">
                                <span>Лікар</span>
                            </div>
                            <div class="flex items-center">
                                <button data-role="doctor" data-action="decrease" class="w-8 h-8 bg-gray-600 hover:bg-gray-500 rounded-l-lg flex items-center justify-center">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <span id="doctorCount" class="role-quantity">0</span>
                                <button data-role="doctor" data-action="increase" class="w-8 h-8 bg-gray-600 hover:bg-gray-500 rounded-r-lg flex items-center justify-center">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="flex items-center justify-between bg-gray-700 p-3 rounded-lg">
                            <div class="flex items-center">
                                <img src="img/P LOVER.png" class="w-8 h-8 rounded-full mr-3">
                                <span>Коханка</span>
                            </div>
                            <div class="flex items-center">
                                <button data-role="lover" data-action="decrease" class="w-8 h-8 bg-gray-600 hover:bg-gray-500 rounded-l-lg flex items-center justify-center">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <span id="loverCount" class="role-quantity">0</span>
                                <button data-role="lover" data-action="increase" class="w-8 h-8 bg-gray-600 hover:bg-gray-500 rounded-r-lg flex items-center justify-center">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="flex items-center justify-between bg-gray-700 p-3 rounded-lg">
                            <div class="flex items-center">
                                <img src="img/P MANIAC.png" class="w-8 h-8 rounded-full mr-3">
                                <span>Маніяк</span>
                            </div>
                            <div class="flex items-center">
                                <button data-role="maniac" data-action="decrease" class="w-8 h-8 bg-gray-600 hover:bg-gray-500 rounded-l-lg flex items-center justify-center">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <span id="maniacCount" class="role-quantity">0</span>
                                <button data-role="maniac" data-action="increase" class="w-8 h-8 bg-gray-600 hover:bg-gray-500 rounded-r-lg flex items-center justify-center">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="flex items-center justify-between bg-gray-700 p-3 rounded-lg">
                            <div class="flex items-center">
                                <img src="img/P WITNESS.png" class="w-8 h-8 rounded-full mr-3">
                                <span>Свідок</span>
                            </div>
                            <div class="flex items-center">
                                <button data-role="witness" data-action="decrease" class="w-8 h-8 bg-gray-600 hover:bg-gray-500 rounded-l-lg flex items-center justify-center">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <span id="witnessCount" class="role-quantity">0</span>
                                <button data-role="witness" data-action="increase" class="w-8 h-8 bg-gray-600 hover:bg-gray-500 rounded-r-lg flex items-center justify-center">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="flex items-center justify-between bg-gray-700 p-3 rounded-lg">
                            <div class="flex items-center">
                                <img src="img/P CIVILIAN.png" class="w-8 h-8 rounded-full mr-3">
                                <span>Мирний</span>
                            </div>
                            <div class="flex items-center">
                                <button data-role="civilian" data-action="decrease" class="w-8 h-8 bg-gray-600 hover:bg-gray-500 rounded-l-lg flex items-center justify-center">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <span id="civilianCount" class="role-quantity">0</span>
                                <button data-role="civilian" data-action="increase" class="w-8 h-8 bg-gray-600 hover:bg-gray-500 rounded-r-lg flex items-center justify-center">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 text-center">
                        <button id="startGameBtn" class="px-6 py-3 bg-green-600 hover:bg-green-500 text-white font-bold rounded-lg transition-all transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none">
                            <i class="fas fa-play mr-2"></i>Почати гру
                        </button>
                    </div>
                </div>
            </div>

            <!-- Екран знайомства (Ніч 0) -->
            <div id="introductionScreen" class="hidden">
                <h2 class="text-2xl font-semibold mb-6 text-center">Знайомство з ролями</h2>
                <div class="bg-gray-800 rounded-lg p-6 mb-8 shadow-lg">
                    <div id="introSteps" class="mb-6 text-center">
                        <div class="player-label text-lg font-medium">Гравець: <span id="currentPlayerName"></span></div>
                        <div class="card-container">
                            <div class="card">
                                <div class="card-front"></div>
                                <div class="card-back"></div>
                            </div>
                        </div>
                    </div>
                    <div class="text-center">
                        <button id="continueIntroBtn" class="px-6 py-3 bg-purple-600 hover:bg-purple-500 text-white font-bold rounded-lg transition-all transform hover:scale-105">
                            Продовжити <i class="fas fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Екран гри -->
            <div id="gameScreen" class="hidden">
                <h2 id="gamePhaseTitle" class="text-2xl font-semibold mb-6 text-center">
                    <i class="fas fa-sun mr-2"></i>День 1
                </h2>

                <!-- Поточна дія -->
                <div id="currentAction" class="bg-gray-800 rounded-lg p-6 mb-8 shadow-lg">
                    <div class="intro-step">
                        <h3 class="text-xl font-medium mb-3 flex items-center justify-between">
                            <span id="actionTitle" class="bg-gray-700 px-3 py-2 rounded-lg">
                                <i class="fas fa-sun mr-2"></i>Денне обговорення
                            </span>
                            <span id="actionProgress" class="text-sm bg-gray-700 px-2 py-1 rounded"></span>
                        </h3>
                        <p id="actionDescription" class="mb-4">Гравці обговорюють і висувають кандидатів на голосування.</p>
                        <div id="playersToSelect" class="players-to-select grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 mb-4">
                            <!-- Гравці для вибору -->
                        </div>
                    </div>
                </div>

                <!-- Кнопка наступної фази -->
                <div class="mb-6 flex justify-center">
                    <button id="nextPhaseBtn" class="px-6 py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg transition-all transform hover:scale-105">
                        <span id="btnPhaseText">Місто засинає</span>
                        <i class="fas fa-moon ml-2" id="btnPhaseIcon"></i>
                    </button>
                </div>

                <!-- Живі гравці -->
                <div class="bg-gray-800 rounded-lg p-6 mb-6 shadow-lg">
                    <h3 class="text-xl font-medium mb-4 flex items-center">
                        <i class="fas fa-heartbeat mr-2"></i>Живі гравці <span id="aliveCount" class="text-sm font-normal ml-2">0 гравців</span>
                    </h3>
                    <div id="alivePlayers" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                        <!-- Живі -->
                    </div>
                </div>

                <!-- Мертві та вигнані -->
                <div class="bg-gray-800 rounded-lg p-6 shadow-lg mb-6">
                    <h3 class="text-xl font-medium mb-4 flex items-center">
                        <i class="fas fa-skull mr-2"></i>Мертві та вигнані <span id="deadCount" class="text-sm font-normal ml-2">0 гравців</span>
                    </h3>
                    <div id="deadPlayers" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                        <!-- Мертві та вигнані -->
                    </div>
                </div>

                <!-- Лог подій -->
                <div class="bg-gray-800 rounded-lg p-6 mt-6 shadow-lg">
                    <h3 class="text-xl font-medium mb-4 flex items-center">
                        <i class="fas fa-scroll mr-2"></i>Лог подій
                    </h3>
                    <div id="gameLog" class="bg-gray-900 p-4 rounded-lg h-64 overflow-y-auto scrollbar-custom">
                        <!-- Події -->
                    </div>
                </div>

                <!-- Завершення гри -->
                <div class="mt-6 text-center">
                    <button id="endGameBtn" class="px-6 py-3 bg-red-600 hover:bg-red-500 text-white font-bold rounded-lg transition-transform transform hover:scale-105">
                        <i class="fas fa-power-off mr-2"></i>Завершити гру
                    </button>
                </div>
            </div>
        </div>

        <footer class="py-4 bg-gray-900 text-center text-gray-400">
            <p>Гра "Мафія" © 2025 | Система для ведучого</p>
        </footer>
    </div>

    <script>
        const rolesData = [
            { name: 'Коханка', id: 'lover', profileImage: 'img/P LOVER.png', cardImage: 'img/C LOVER.jpg', team: 'civilian' },
            { name: 'Мафія', id: 'mafia', profileImage: 'img/P MAFIA.png', cardImage: 'img/C MAFIA.jpg', team: 'mafia' },
            { name: 'Дон', id: 'don', profileImage: 'img/P DON.png', cardImage: 'img/C DON.png', team: 'mafia' },
            { name: 'Шериф', id: 'sheriff', profileImage: 'img/P SHERIFF.png', cardImage: 'img/C SHERIFF.png', team: 'civilian' },
            { name: 'Лікар', id: 'doctor', profileImage: 'img/P DOCTOR.png', cardImage: 'img/C DOCTOR.png', team: 'civilian' },
            { name: 'Маніяк', id: 'maniac', profileImage: 'img/P MANIAC.png', cardImage: 'img/C MANIAC.png', team: 'solo' },
            { name: 'Свідок', id: 'witness', profileImage: 'img/P WITNESS.png', cardImage: 'img/C WITNESS.jpg', team: 'civilian' },
            { name: 'Мирний', id: 'civilian', profileImage: 'img/P CIVILIAN.png', cardImage: 'img/C CIVILIAN.jpg', team: 'civilian' }
        ];

        let players = [];
        let assignedRoles = [];
        let currentPhase = 'setup';
        let currentDay = 1;
        let currentPlayerIndex = 0;
        let nightActions = {};
        let votingCandidates = [];
        let gameLog = [];
        let selectedPlayer = null;

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Додавання гравця
            document.getElementById('addPlayerBtn').addEventListener('click', () => {
                const name = document.getElementById('playerNameInput').value.trim();
                if (name && !players.some(p => p.name === name)) {
                    players.push({ name, status: 'alive', role: null });
                    renderPlayersList();
                    document.getElementById('playerNameInput').value = '';
                    updatePlayerCount();
                } else {
                    alert('Введіть унікальне ім\'я гравця!');
                }
            });

            // Керування ролями
            document.querySelectorAll('[data-role]').forEach(button => {
                button.addEventListener('click', () => {
                    const role = button.dataset.role;
                    const action = button.dataset.action;
                    const countSpan = document.getElementById(`${role}Count`);
                    let count = parseInt(countSpan.textContent);
                    if (action === 'increase') count++;
                    if (action === 'decrease' && count > 0) count--;
                    countSpan.textContent = count;
                    updateStartGameButton();
                });
            });

            // Початок гри
            document.getElementById('startGameBtn').addEventListener('click', () => {
                const playerCount = players.length;
                const roleCounts = rolesData.reduce((sum, role) => sum + parseInt(document.getElementById(`${role.id}Count`).textContent), 0);
                if (roleCounts === playerCount) {
                    assignRoles();
                    document.getElementById('setupScreen').classList.add('hidden');
                    document.getElementById('introductionScreen').classList.remove('hidden');
                    currentPhase = 'introduction';
                    renderIntroductionCard();
                } else {
                    alert('Кількість ролей має відповідати кількості гравців!');
                }
            });

            // Продовження знайомства
            document.getElementById('continueIntroBtn').addEventListener('click', () => {
                const card = document.querySelector('.card');
                if (card.classList.contains('flipped')) {
                    card.classList.remove('flipped');
                    setTimeout(() => {
                        currentPlayerIndex++;
                        if (currentPlayerIndex < players.length) {
                            renderIntroductionCard();
                        } else {
                            document.getElementById('introductionScreen').classList.add('hidden');
                            document.getElementById('gameScreen').classList.remove('hidden');
                            currentPhase = 'day';
                            startDayPhase();
                        }
                    }, 600);
                } else {
                    card.classList.add('flipped');
                }
            });

            // Наступна фаза
            document.getElementById('nextPhaseBtn').addEventListener('click', () => {
                if (currentPhase === 'day') {
                    currentPhase = 'night';
                    startNightPhase();
                } else {
                    currentPhase = 'day';
                    currentDay++;
                    resolveNightActions();
                    startDayPhase();
                }
            });

            // Завершення гри
            document.getElementById('endGameBtn').addEventListener('click', () => {
                document.getElementById('confirmModal').classList.remove('hidden');
            });

            document.getElementById('confirmCancel').addEventListener('click', () => {
                document.getElementById('confirmModal').classList.add('hidden');
            });

            document.getElementById('confirmEnd').addEventListener('click', () => {
                resetGame();
            });
        });

        function renderPlayersList() {
            const playersList = document.getElementById('playersList');
            playersList.innerHTML = '';
            players.forEach((player, index) => {
                const playerCard = document.createElement('div');
                playerCard.className = 'player-card bg-gray-700 p-3 rounded-lg flex justify-between items-center';
                playerCard.innerHTML = `
                    <span>${player.name}</span>
                    <button class="text-red-500 hover:text-red-400" onclick="players.splice(${index}, 1); renderPlayersList(); updatePlayerCount(); updateStartGameButton();">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                playersList.appendChild(playerCard);
            });
            updatePlayerCount();
        }

        function updatePlayerCount() {
            document.getElementById('playersCount').textContent = `${players.length} гравців`;
        }

        function updateStartGameButton() {
            const startBtn = document.getElementById('startGameBtn');
            const playerCount = players.length;
            const roleCounts = rolesData.reduce((sum, role) => sum + parseInt(document.getElementById(`${role.id}Count`).textContent), 0);
            startBtn.disabled = playerCount !== roleCounts;
        }

        function assignRoles() {
            assignedRoles = [];
            rolesData.forEach(role => {
                const count = parseInt(document.getElementById(`${role.id}Count`).textContent);
                for (let i = 0; i < count; i++) {
                    assignedRoles.push(role);
                }
            });
            assignedRoles = shuffle(assignedRoles);
            players.forEach((player, index) => {
                player.role = assignedRoles[index];
            });
        }

        function renderIntroductionCard() {
            const player = players[currentPlayerIndex];
            document.getElementById('currentPlayerName').textContent = player.name;
            document.querySelector('.card-front').style.backgroundImage = `url('${player.role.cardImage}')`;
        }

        function startDayPhase() {
            document.getElementById('gamePhaseTitle').innerHTML = `<i class="fas fa-sun mr-2"></i>День ${currentDay}`;
            document.getElementById('actionTitle').innerHTML = `<i class="fas fa-sun mr-2"></i>Денне обговорення`;
            document.getElementById('actionDescription').textContent = 'Гравці обговорюють і висувають кандидатів на голосування.';
            document.getElementById('actionProgress').textContent = `${votingCandidates.length}/${players.filter(p => p.status === 'alive').length}`;
            const playersToSelect = document.getElementById('playersToSelect');
            playersToSelect.innerHTML = '';
            players.filter(p => p.status === 'alive').forEach(player => {
                const playerCard = document.createElement('div');
                playerCard.className = `player-card bg-gray-700 p-3 rounded-lg cursor-pointer hover:scale-105 ${votingCandidates.includes(player.name) ? 'selected-player' : ''}`;
                playerCard.dataset.name = player.name;
                playerCard.innerHTML = `
                    <div class="text-center">
                        <img src="${player.role.profileImage}" class="w-12 h-12 rounded-full mx-auto mb-2">
                        <div class="font-medium">${player.name}</div>
                        <div class="text-xs text-gray-400">${player.role.name}</div>
                    </div>
                `;
                playerCard.addEventListener('click', () => {
                    if (votingCandidates.includes(player.name)) {
                        votingCandidates = votingCandidates.filter(c => c !== player.name);
                    } else {
                        votingCandidates.push(player.name);
                    }
                    renderDayPhase();
                    if (votingCandidates.length >= 2) {
                        conductVoting();
                    }
                });
                playersToSelect.appendChild(playerCard);
            });
            renderPlayers();
            checkWinCondition();
        }

        function renderDayPhase() {
            const playersToSelect = document.getElementById('playersToSelect');
            playersToSelect.innerHTML = '';
            players.filter(p => p.status === 'alive').forEach(player => {
                const playerCard = document.createElement('div');
                playerCard.className = `player-card bg-gray-700 p-3 rounded-lg cursor-pointer hover:scale-105 ${votingCandidates.includes(player.name) ? 'selected-player' : ''}`;
                playerCard.dataset.name = player.name;
                playerCard.innerHTML = `
                    <div class="text-center">
                        <img src="${player.role.profileImage}" class="w-12 h-12 rounded-full mx-auto mb-2">
                        <div class="font-medium">${player.name}</div>
                        <div class="text-xs text-gray-400">${player.role.name}</div>
                    </div>
                `;
                playerCard.addEventListener('click', () => {
                    if (votingCandidates.includes(player.name)) {
                        votingCandidates = votingCandidates.filter(c => c !== player.name);
                    } else {
                        votingCandidates.push(player.name);
                    }
                    renderDayPhase();
                    if (votingCandidates.length >= 2) {
                        conductVoting();
                    }
                });
                playersToSelect.appendChild(playerCard);
            });
            document.getElementById('actionProgress').textContent = `${votingCandidates.length}/${players.filter(p => p.status === 'alive').length}`;
        }

        function conductVoting() {
            if (votingCandidates.length < 2) {
                gameLog.push(`День ${currentDay}: Недостатньо кандидатів для голосування.`);
                votingCandidates = [];
                renderDayPhase();
                renderGameLog();
                return;
            }

            const votes = {};
            votingCandidates.forEach(candidate => {
                votes[candidate] = Math.floor(Math.random() * players.filter(p => p.status === 'alive').length);
            });

            const maxVotes = Math.max(...Object.values(votes));
            const topCandidates = votingCandidates.filter(c => votes[c] === maxVotes);

            if (topCandidates.length === 1) {
                const exiledPlayer = players.find(p => p.name === topCandidates[0]);
                if (exiledPlayer.role.id === 'lover') {
                    gameLog.push(`День ${currentDay}: Гравець ${exiledPlayer.name} має алібі від Коханки і залишається в грі.`);
                } else {
                    exiledPlayer.status = 'exiled';
                    exiledPlayer.deathReason = 'Вигнаний';
                    exiledPlayer.deathTime = `День ${currentDay}`;
                    gameLog.push(`День ${currentDay}: Гравець ${exiledPlayer.name} вигнаний за голосуванням.`);
                }
            } else {
                gameLog.push(`День ${currentDay}: Нічия між ${topCandidates.join(' і ')}. Переголосування.`);
                votingCandidates = topCandidates;
            }

            renderDayPhase();
            renderPlayers();
            renderGameLog();
            checkWinCondition();
        }

        function startNightPhase() {
            document.getElementById('gamePhaseTitle').innerHTML = `<i class="fas fa-moon mr-2"></i>Ніч ${currentDay}`;
            nightActions = { lover: null, witness: null, mafia: null, don: null, sheriff: null, doctor: null, maniac: null };
            const alivePlayers = players.filter(p => p.status === 'alive');
            let actionIndex = 0;
            const actions = [
                { role: 'lover', title: 'Виберіть гравця для Коханки', desc: 'Коханка обирає гравця для блокування.', icon: 'fa-heart' },
                { role: 'witness', title: 'Виберіть гравця для Свідка', desc: 'Свідок обирає гравця для спостереження.', icon: 'fa-eye' },
                { role: 'mafia', title: 'Виберіть жертву Мафії', desc: 'Мафія обирає жертву.', icon: 'fa-user-secret' },
                { role: 'don', title: 'Виберіть гравця для перевірки Доном', desc: 'Дон перевіряє гравця на роль Шерифа.', icon: 'fa-crown' },
                { role: 'sheriff', title: 'Виберіть гравця для перевірки Шерифом', desc: 'Шериф перевіряє гравця на належність до Мафії.', icon: 'fa-search' },
                { role: 'doctor', title: 'Виберіть гравця для Лікаря', desc: 'Лікар обирає гравця для порятунку.', icon: 'fa-heartbeat' },
                { role: 'maniac', title: 'Виберіть жертву Маніяка', desc: 'Маніяк обирає жертву.', icon: 'fa-skull' }
            ];

            function processAction() {
                if (actionIndex >= actions.length) {
                    currentPhase = 'day';
                    currentDay++;
                    resolveNightActions();
                    startDayPhase();
                    return;
                }

                const action = actions[actionIndex];
                const rolePlayer = alivePlayers.find(p => p.role.id === action.role);
                if (!rolePlayer || (action.role === 'lover' && nightActions.lover) || (action.role === 'witness' && nightActions.witness)) {
                    actionIndex++;
                    processAction();
                    return;
                }

                document.getElementById('actionTitle').innerHTML = `<i class="fas ${action.icon} mr-2"></i>${action.title}`;
                document.getElementById('actionDescription').textContent = action.desc;
                document.getElementById('actionProgress').textContent = `${actionIndex + 1}/${actions.length}`;
                const playersToSelect = document.getElementById('playersToSelect');
                playersToSelect.innerHTML = '';
                alivePlayers.forEach(player => {
                    if (
                        (action.role === 'lover' && player !== rolePlayer && player !== nightActions.loverLastNight) ||
                        (action.role === 'witness' && player !== rolePlayer && player !== nightActions.witnessLastNight) ||
                        (action.role === 'mafia' && player.role.team !== 'mafia') ||
                        (action.role === 'don' && player.status === 'alive') ||
                        (action.role === 'sheriff' && player.status === 'alive') ||
                        (action.role === 'doctor' && player !== nightActions.doctorLastNight) ||
                        (action.role === 'maniac' && player.status === 'alive')
                    ) {
                        const playerCard = document.createElement('div');
                        playerCard.className = `player-card bg-gray-700 p-3 rounded-lg cursor-pointer hover:scale-105 ${selectedPlayer === player.name ? 'selected-player' : ''}`;
                        playerCard.dataset.name = player.name;
                        playerCard.innerHTML = `
                            <div class="text-center">
                                <img src="${player.role.profileImage}" class="w-12 h-12 rounded-full mx-auto mb-2">
                                <div class="font-medium">${player.name}</div>
                                <div class="text-xs text-gray-400">${player.role.name}</div>
                            </div>
                        `;
                        playerCard.addEventListener('click', () => {
                            selectedPlayer = player.name;
                            nightActions[action.role] = selectedPlayer ? players.find(p => p.name === selectedPlayer) : null;
                            if (action.role === 'lover') nightActions.loverLastNight = nightActions.lover;
                            if (action.role === 'witness') nightActions.witnessLastNight = nightActions.witness;
                            if (action.role === 'doctor') nightActions.doctorLastNight = nightActions.doctor;
                            selectedPlayer = null;
                            actionIndex++;
                            processAction();
                        });
                        playersToSelect.appendChild(playerCard);
                    } else {
                        const playerCard = document.createElement('div');
                        playerCard.className = 'player-card bg-gray-700 p-3 rounded-lg opacity-50 pointer-events-none';
                        playerCard.dataset.name = player.name;
                        playerCard.innerHTML = `
                            <div class="text-center">
                                <img src="${player.role.profileImage}" class="w-12 h-12 rounded-full mx-auto mb-2">
                                <div class="font-medium">${player.name}</div>
                                <div class="text-xs text-gray-400">${player.role.name}</div>
                            </div>
                        `;
                        playersToSelect.appendChild(playerCard);
                    }
                });

                if (action.role === 'maniac') {
                    const skipBtn = document.createElement('button');
                    skipBtn.className = 'px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-lg mt-4';
                    skipBtn.textContent = 'Пропустити хід';
                    skipBtn.addEventListener('click', () => {
                        selectedPlayer = null;
                        nightActions[action.role] = null;
                        actionIndex++;
                        processAction();
                    });
                    playersToSelect.appendChild(skipBtn);
                }
            }

            processAction();
            renderPlayers();
        }

        function renderNightPhase(actionIndex) {
            const playersToSelect = document.getElementById('playersToSelect');
            playersToSelect.innerHTML = '';
            const alivePlayers = players.filter(p => p.status === 'alive');
            const action = [
                { role: 'lover', title: 'Виберіть гравця для Коханки', desc: 'Коханка обирає гравця для блокування.', icon: 'fa-heart' },
                { role: 'witness', title: 'Виберіть гравця для Свідка', desc: 'Свідок обирає гравця для спостереження.', icon: 'fa-eye' },
                { role: 'mafia', title: 'Виберіть жертву Мафії', desc: 'Мафія обирає жертву.', icon: 'fa-user-secret' },
                { role: 'don', title: 'Виберіть гравця для перевірки Доном', desc: 'Дон перевіряє гравця на роль Шерифа.', icon: 'fa-crown' },
                { role: 'sheriff', title: 'Виберіть гравця для перевірки Шерифом', desc: 'Шериф перевіряє гравця на належність до Мафії.', icon: 'fa-search' },
                { role: 'doctor', title: 'Виберіть гравця для Лікаря', desc: 'Лікар обирає гравця для порятунку.', icon: 'fa-heartbeat' },
                { role: 'maniac', title: 'Виберіть жертву Маніяка', desc: 'Маніяк обирає жертву.', icon: 'fa-skull' }
            ][actionIndex];

            alivePlayers.forEach(player => {
                if (
                    (action.role === 'lover' && player !== players.find(p => p.role.id === 'lover') && player !== nightActions.loverLastNight) ||
                    (action.role === 'witness' && player !== players.find(p => p.role.id === 'witness') && player !== nightActions.witnessLastNight) ||
                    (action.role === 'mafia' && player.role.team !== 'mafia') ||
                    (action.role === 'don' && player.status === 'alive') ||
                    (action.role === 'sheriff' && player.status === 'alive') ||
                    (action.role === 'doctor' && player !== nightActions.doctorLastNight) ||
                    (action.role === 'maniac' && player.status === 'alive')
                ) {
                    const playerCard = document.createElement('div');
                    playerCard.className = `player-card bg-gray-700 p-3 rounded-lg cursor-pointer hover:scale-105 ${selectedPlayer === player.name ? 'selected-player' : ''}`;
                    playerCard.dataset.name = player.name;
                    playerCard.innerHTML = `
                        <div class="text-center">
                            <img src="${player.role.profileImage}" class="w-12 h-12 rounded-full mx-auto mb-2">
                            <div class="font-medium">${player.name}</div>
                            <div class="text-xs text-gray-400">${player.role.name}</div>
                        </div>
                    `;
                    playerCard.addEventListener('click', () => {
                        selectedPlayer = player.name;
                        nightActions[action.role] = selectedPlayer ? players.find(p => p.name === selectedPlayer) : null;
                        if (action.role === 'lover') nightActions.loverLastNight = nightActions.lover;
                        if (action.role === 'witness') nightActions.witnessLastNight = nightActions.witness;
                        if (action.role === 'doctor') nightActions.doctorLastNight = nightActions.doctor;
                        selectedPlayer = null;
                        actionIndex++;
                        startNightPhase();
                    });
                    playersToSelect.appendChild(playerCard);
                } else {
                    const playerCard = document.createElement('div');
                    playerCard.className = 'player-card bg-gray-700 p-3 rounded-lg opacity-50 pointer-events-none';
                    playerCard.dataset.name = player.name;
                    playerCard.innerHTML = `
                        <div class="text-center">
                            <img src="${player.role.profileImage}" class="w-12 h-12 rounded-full mx-auto mb-2">
                            <div class="font-medium">${player.name}</div>
                            <div class="text-xs text-gray-400">${player.role.name}</div>
                        </div>
                    `;
                    playersToSelect.appendChild(playerCard);
                }
            });

            if (action.role === 'maniac') {
                const skipBtn = document.createElement('button');
                skipBtn.className = 'px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-lg mt-4';
                skipBtn.textContent = 'Пропустити хід';
                skipBtn.addEventListener('click', () => {
                    selectedPlayer = null;
                    nightActions[action.role] = null;
                    actionIndex++;
                    startNightPhase();
                });
                playersToSelect.appendChild(skipBtn);
            }

            document.getElementById('actionProgress').textContent = `${actionIndex + 1}/${actions.length}`;
        }

        function resolveNightActions() {
            const log = [];
            const killed = [];

            // Коханка
            if (nightActions.lover) {
                log.push(`Ніч ${currentDay - 1}: Коханка відвідала ${nightActions.lover.name}.`);
                if (nightActions.mafia === nightActions.lover) nightActions.mafia = null;
                if (nightActions.don === nightActions.lover) nightActions.don = null;
                if (nightActions.sheriff === nightActions.lover) nightActions.sheriff = null;
                if (nightActions.doctor === nightActions.lover) nightActions.doctor = null;
                if (nightActions.maniac === nightActions.lover) nightActions.maniac = null;
            }

            // Мафія
            if (nightActions.mafia && nightActions.mafia !== nightActions.doctor) {
                if (nightActions.mafia === players.find(p => p.role.id === 'lover')) {
                    killed.push(nightActions.mafia, nightActions.lover);
                    log.push(`Ніч ${currentDay - 1}: Мафія вбила ${nightActions.mafia.name} і ${nightActions.lover.name} (Коханка).`);
                } else {
                    killed.push(nightActions.mafia);
                    log.push(`Ніч ${currentDay - 1}: Мафія вбила ${nightActions.mafia.name}.`);
                }
            } else if (nightActions.mafia && nightActions.mafia === nightActions.doctor) {
                log.push(`Ніч ${currentDay - 1}: Лікар врятував ${nightActions.mafia.name} від Мафії.`);
            }

            // Маніяк
            if (nightActions.maniac && nightActions.maniac !== nightActions.doctor) {
                if (!killed.includes(nightActions.maniac)) {
                    if (nightActions.maniac === players.find(p => p.role.id === 'lover')) {
                        killed.push(nightActions.maniac, nightActions.lover);
                        log.push(`Ніч ${currentDay - 1}: Маніяк вбив ${nightActions.maniac.name} і ${nightActions.lover.name} (Коханка).`);
                    } else {
                        killed.push(nightActions.maniac);
                        log.push(`Ніч ${currentDay - 1}: Маніяк вбив ${nightActions.maniac.name}.`);
                    }
                }
            } else if (nightActions.maniac && nightActions.maniac === nightActions.doctor) {
                log.push(`Ніч ${currentDay - 1}: Лікар врятував ${nightActions.maniac.name} від Маніяка.`);
            }

            // Дон
            if (nightActions.don) {
                const isSheriff = nightActions.don.role.id === 'sheriff';
                log.push(`Ніч ${currentDay - 1}: Дон перевірив ${nightActions.don.name} — ${isSheriff ? 'Шериф' : 'не Шериф'}.`);
            }

            // Шериф
            if (nightActions.sheriff) {
                const isMafia = nightActions.sheriff.role.team === 'mafia';
                log.push(`Ніч ${currentDay - 1}: Шериф перевірив ${nightActions.sheriff.name} — ${isMafia ? 'Мафія' : 'не Мафія'}.`);
            }

            // Свідок
            if (nightActions.witness && killed.includes(nightActions.witness)) {
                const killer = nightActions.mafia === nightActions.witness ? 'Мафія' : 'Маніяк';
                log.push(`Ніч ${currentDay - 1}: Свідок побачив, що ${nightActions.witness.name} вбив ${killer}.`);
            } else if (nightActions.witness) {
                log.push(`Ніч ${currentDay - 1}: Свідок спостерігав за ${nightActions.witness.name}, але нічого не сталося.`);
            }

            killed.forEach(player => {
                player.status = 'dead';
                player.deathReason = player === nightActions.mafia ? 'Вбитий (Мафія)' : 'Вбитий (Маніяк)';
                player.deathTime = `Ніч ${currentDay - 1}`;
            });

            gameLog.push(...log);
            renderGameLog();
            renderPlayers();
        }

        function renderPlayers() {
            const alivePlayers = document.getElementById('alivePlayers');
            const deadPlayers = document.getElementById('deadPlayers');
            alivePlayers.innerHTML = '';
            deadPlayers.innerHTML = '';
            players.forEach(player => {
                const container = player.status === 'alive' ? alivePlayers : deadPlayers;
                const playerCard = document.createElement('div');
                playerCard.className = `player-profile ${player.status !== 'alive' ? 'dead-player' : ''}`;
                playerCard.innerHTML = `
                    <img src="${player.role.profileImage}" alt="${player.role.name}">
                    <div class="name">${player.name}</div>
                    <div class="role">${player.role.name}</div>
                    ${player.status !== 'alive' ? `<div class="status">${player.deathReason}, ${player.deathTime}</div>` : ''}
                `;
                container.appendChild(playerCard);
            });
            document.getElementById('aliveCount').textContent = `${players.filter(p => p.status === 'alive').length} гравців`;
            document.getElementById('deadCount').textContent = `${players.filter(p => p.status !== 'alive').length} гравців`;
        }

        function renderGameLog() {
            const gameLogDiv = document.getElementById('gameLog');
            gameLogDiv.innerHTML = gameLog.map(event => `<p>${event}</p>`).join('');
            gameLogDiv.scrollTop = gameLogDiv.scrollHeight;
        }

        function checkWinCondition() {
            const alivePlayers = players.filter(p => p.status === 'alive');
            const mafiaCount = alivePlayers.filter(p => p.role.team === 'mafia').length;
            const civilianCount = alivePlayers.filter(p => p.role.team === 'civilian').length;
            const maniacCount = alivePlayers.filter(p => p.role.id === 'maniac').length;

            if (mafiaCount >= civilianCount) {
                alert('Мафія перемогла!');
                resetGame();
            } else if (maniacCount === 1 && alivePlayers.length === 2 && civilianCount === 1) {
                alert('Маніяк переміг!');
                resetGame();
            } else if (mafiaCount === 0 && maniacCount === 0) {
                alert('Мирні перемогли!');
                resetGame();
            }
        }

        function resetGame() {
            players = [];
            assignedRoles = [];
            currentPhase = 'setup';
            currentDay = 1;
            currentPlayerIndex = 0;
            nightActions = {};
            votingCandidates = [];
            gameLog = [];
            selectedPlayer = null;
            document.getElementById('playersList').innerHTML = '';
            document.getElementById('alivePlayers').innerHTML = '';
            document.getElementById('deadPlayers').innerHTML = '';
            document.getElementById('gameLog').innerHTML = '';
            document.getElementById('playersCount').textContent = '0 гравців';
            document.getElementById('aliveCount').textContent = '0 гравців';
            document.getElementById('deadCount').textContent = '0 гравців';
            rolesData.forEach(role => {
                document.getElementById(`${role.id}Count`).textContent = '0';
            });
            document.getElementById('confirmModal').classList.add('hidden');
            document.getElementById('gameScreen').classList.add('hidden');
            document.getElementById('introductionScreen').classList.add('hidden');
            document.getElementById('setupScreen').classList.remove('hidden');
            updateStartGameButton();
        }
    </script>
</body>
</html>
